<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤ªç©ºå¸å›½ - å¾æœå¤ªé˜³ç³»</title>
    <style>
        :root {
            --font-ui:    'Courier New', Consolas, 'SF Mono', monospace;
            --font-body:  -apple-system, 'PingFang SC', 'Microsoft YaHei', 'Hiragino Sans GB', sans-serif;
            --font-mono:  'Courier New', Consolas, monospace;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e1a;
            --bg-panel: rgba(15, 23, 42, 0.92);
            --accent-cyan: #00d9ff;
            --accent-purple: #a855f7;
            --accent-gold: #fbbf24;
            --accent-green: #10b981;
            --text-white: #ffffff;
            --text-gray: #94a3b8;
        }

        body {
            font-family: var(--font-body);
            background: #000;
            color: var(--text-white);
            overflow: hidden;
            min-height: 100vh;
        }

        /* å®‡å®™ç”»å¸ƒ */
        .universe-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: radial-gradient(ellipse at center, #0a0e1a 0%, #000 100%);
        }

        #universeCanvas {
            width: 100%;
            height: 100%;
        }

        /* UIå±‚ */
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .ui-overlay > * {
            pointer-events: auto;
        }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1.5rem 2rem;
            background: linear-gradient(to bottom, rgba(10, 14, 26, 0.95), transparent);
            backdrop-filter: blur(10px);
        }

        .civilization-level {
            text-align: center;
            font-family: var(--font-ui);
            font-size: 1.1rem;
            color: var(--accent-gold);
            margin-bottom: 0;
            white-space: nowrap;
        }

        .top-status-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.7rem;
            margin-bottom: 0.8rem;
            flex-wrap: nowrap;
        }

        .top-inline-actions {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            flex-wrap: nowrap;
        }

        .resources-compact {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .resource-compact {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 0.35rem 0.7rem;
            border-radius: 20px;
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .resource-icon-small {
            font-size: 1.25rem;
        }

        .resource-value-small {
            font-family: var(--font-mono);
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-cyan);
            line-height: 1.1;
        }

        .resource-rate-small {
            font-size: 0.72rem;
            color: var(--accent-green);
            line-height: 1.1;
        }

        .home-btn {
            padding: 0.5rem 1rem;
            background: rgba(59, 130, 246, 0.15);
            border: 1.5px solid rgba(59, 130, 246, 0.4);
            border-radius: 8px;
            color: #3b82f6;
            font-family: var(--font-ui);
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            text-decoration: none;
            display: inline-block;
        }

        .home-btn:hover {
            background: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.7);
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .reset-btn {
            padding: 0.5rem 1rem;
            background: rgba(220, 38, 38, 0.15);
            border: 1.5px solid rgba(220, 38, 38, 0.4);
            border-radius: 8px;
            color: #ef4444;
            font-family: var(--font-ui);
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .reset-btn:hover {
            background: rgba(220, 38, 38, 0.3);
            border-color: rgba(220, 38, 38, 0.7);
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }

        .bottom-actions {
            display: none;
            justify-content: center;
            gap: 0.8rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* åº•éƒ¨æ§åˆ¶é¢æ¿ */
        .bottom-panel {
            position: fixed;
            top: 5.5rem;
            right: 0.8rem;
            bottom: 1rem;
            left: auto;
            width: min(440px, 36vw);
            background: rgba(10, 14, 26, 0.96);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 217, 255, 0.25);
            border-radius: 14px;
            padding: 1rem;
            overflow-y: auto;
            transition: transform 0.25s ease, opacity 0.25s ease;
            z-index: 1250;
        }

        .panel-tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .panel-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.6rem;
        }

        .panel-topbar .panel-tabs {
            flex: 1;
            margin-bottom: 0;
        }

        .panel-close-btn {
            border: 1px solid rgba(239, 68, 68, 0.45);
            background: rgba(239, 68, 68, 0.15);
            color: #fca5a5;
            border-radius: 8px;
            padding: 0.35rem 0.65rem;
            font-size: 0.72rem;
            font-family: var(--font-ui);
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            margin-left: auto;
            transition: all 0.2s ease;
        }

        .panel-close-btn:hover {
            background: rgba(239, 68, 68, 0.25);
            border-color: rgba(248, 113, 113, 0.7);
        }

        .tab-button {
            font-family: var(--font-ui);
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: var(--text-gray);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .tab-button.active {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .tab-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upgrades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .upgrade-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upgrade-card:hover:not(.disabled) {
            background: rgba(0, 217, 255, 0.1);
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }

        .upgrade-card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .upgrade-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .upgrade-name {
            font-weight: 700;
            font-size: 1rem;
        }

        .upgrade-level-badge {
            background: var(--accent-purple);
            padding: 0.2rem 0.5rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .upgrade-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }

        .upgrade-cost-label {
            color: var(--accent-gold);
            font-family: var(--font-mono);
            font-weight: 700;
        }

        .upgrade-prod-label {
            color: var(--accent-green);
        }

        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .progress-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-panel);
            padding: 1.5rem 2rem;
            border-radius: 15px;
            border: 2px solid var(--accent-gold);
            text-align: center;
            min-width: 350px;
            pointer-events: none;
        }

        .progress-title-main {
            font-family: var(--font-ui);
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 0.8rem;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 0.5rem;
        }

        .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple), var(--accent-gold));
            border-radius: 10px;
            transition: width 0.5s ease;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.6);
        }

        .progress-percentage-text {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        /* é¡¶éƒ¨è¿›åº¦æ¡ */
        .top-progress-bar {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15,23,42,0.75);
            padding: 0.5rem 1.2rem;
            border-radius: 20px;
            border: 1px solid rgba(251,191,36,0.35);
            min-width: 300px;
            max-width: 500px;
            width: 50%;
            backdrop-filter: blur(8px);
            pointer-events: none;
        }

        /* æç¤ºæ–‡æœ¬ */
        .hint-text {
            position: absolute;
            bottom: 45%;
            left: 50%;
            transform: translateX(-50%);
            color: var(--text-gray);
            font-size: 1rem;
            text-align: center;
            pointer-events: none;
            opacity: 0.8;
            animation: hintPulse 2s ease-in-out infinite;
        }

        @keyframes hintPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* é‡Œç¨‹ç¢‘å¼¹çª— */
        .milestone-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.5s ease;
        }

        .milestone-box {
            background: var(--bg-panel);
            border: 3px solid var(--accent-gold);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            max-width: 600px;
            animation: milestoneZoom 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 80px rgba(251, 191, 36, 0.6);
        }

        @keyframes milestoneZoom {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .milestone-emoji {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: emojiFloat 0.6s ease infinite;
        }

        @keyframes emojiFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .milestone-heading {
            font-family: var(--font-ui);
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        .milestone-description {
            font-size: 1.2rem;
            color: var(--text-gray);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .milestone-cta {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border: none;
            padding: 1rem 3rem;
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            font-family: var(--font-ui);
            transition: all 0.3s ease;
        }

        .milestone-cta:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.6);
        }

        /* æµ®åŠ¨æ•°å­— */
        .floating-number {
            position: fixed;
            font-family: var(--font-mono);
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-gold);
            pointer-events: none;
            animation: floatUpAnim 1.5s ease-out forwards;
            text-shadow: 0 0 10px var(--accent-gold);
            z-index: 500;
        }

        @keyframes floatUpAnim {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5);
            }
        }

        /* ç¦»çº¿æ”¶ç›Š */
        .offline-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            animation: fadeIn 0.5s ease;
        }

        .offline-box {
            background: var(--bg-panel);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            border: 2px solid var(--accent-cyan);
            box-shadow: 0 0 60px rgba(0, 217, 255, 0.4);
            max-width: 500px;
        }

        .offline-title {
            font-family: var(--font-ui);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--accent-cyan);
        }

        .offline-amount {
            font-family: var(--font-mono);
            font-size: 3rem;
            font-weight: 900;
            color: var(--accent-gold);
            margin: 1.5rem 0;
            text-shadow: 0 0 30px var(--accent-gold);
        }

        .offline-btn {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border: none;
            padding: 1rem 3rem;
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--font-ui);
        }

        .offline-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.4);
        }

        .slot-build-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.78);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4200;
            padding: 1rem;
        }

        .slot-build-modal.show {
            display: flex;
        }

        .slot-build-box {
            width: min(420px, 92vw);
            background: rgba(15, 23, 42, 0.96);
            border: 1.5px solid rgba(0, 217, 255, 0.45);
            border-radius: 14px;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.25);
            padding: 1rem;
        }

        .slot-build-title {
            font-family: var(--font-ui);
            font-size: 1rem;
            color: var(--accent-cyan);
            font-weight: 700;
            margin-bottom: 0.7rem;
            text-align: center;
        }

        .slot-build-desc {
            color: var(--text-gray);
            font-size: 0.78rem;
            text-align: center;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .slot-build-actions {
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
        }

        .slot-build-btn {
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            border-radius: 10px;
            padding: 0.6rem 0.75rem;
            font-size: 0.8rem;
            font-family: var(--font-ui);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .slot-build-btn:hover:not(:disabled) {
            border-color: rgba(0, 217, 255, 0.5);
            background: rgba(0, 217, 255, 0.15);
        }

        .slot-build-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .slot-build-close {
            margin-top: 0.7rem;
            width: 100%;
            border: 1px solid rgba(239, 68, 68, 0.45);
            background: rgba(239, 68, 68, 0.15);
            color: #fca5a5;
            border-radius: 10px;
            padding: 0.55rem;
            font-size: 0.78rem;
            font-family: var(--font-ui);
            cursor: pointer;
        }

        .level-action-hud {
            position: fixed;
            display: none;
            align-items: center;
            gap: 0.45rem;
            transform: translate(-50%, 0);
            z-index: 1200;
            pointer-events: auto;
        }

        .level-action-btn {
            border: 1px solid rgba(0, 217, 255, 0.45);
            background: rgba(15, 23, 42, 0.9);
            color: #e2e8f0;
            border-radius: 999px;
            padding: 0.35rem 0.75rem;
            font-size: 0.72rem;
            font-weight: 700;
            font-family: var(--font-ui);
            cursor: pointer;
            backdrop-filter: blur(6px);
            white-space: nowrap;
        }

        .level-action-btn:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: rgba(0, 217, 255, 0.75);
        }

        .right-edge-actions {
            position: fixed;
            right: 0.7rem;
            top: 35%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 1300;
        }

        .bottom-panel.is-collapsed {
            transform: translateX(120%);
            opacity: 0;
            pointer-events: none;
        }

        .mvp-meta {
            position: fixed;
            right: 0.7rem;
            bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.45rem;
            z-index: 1320;
            pointer-events: auto;
        }

        .mvp-version-badge {
            border: 1px solid rgba(148, 163, 184, 0.45);
            background: rgba(15, 23, 42, 0.78);
            color: #cbd5e1;
            border-radius: 999px;
            padding: 0.25rem 0.58rem;
            font-family: var(--font-ui);
            font-size: 0.66rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .mvp-feedback-btn {
            appearance: none;
            -webkit-appearance: none;
            border: 1px solid rgba(0, 217, 255, 0.45);
            background: rgba(15, 23, 42, 0.88);
            color: var(--accent-cyan);
            border-radius: 999px;
            padding: 0.28rem 0.68rem;
            font-family: var(--font-ui);
            font-size: 0.7rem;
            font-weight: 700;
            text-decoration: none;
            backdrop-filter: blur(6px);
            cursor: pointer;
        }

        .mvp-feedback-btn:hover {
            background: rgba(0, 217, 255, 0.16);
            border-color: rgba(0, 217, 255, 0.72);
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .civilization-level {
                font-size: 0.78rem;
            }

            .top-status-row {
                gap: 0.35rem;
                margin-bottom: 0.45rem;
            }

            .top-inline-actions {
                gap: 0.25rem;
            }

            .top-bar {
                padding: 0.8rem 0.45rem;
            }

            .home-btn, .reset-btn {
                padding: 0.25rem 0.4rem;
                font-size: 0.58rem;
            }

            .resources-compact {
                gap: 0.35rem;
                flex-wrap: nowrap;
                justify-content: space-between;
            }

            .resource-compact {
                flex: 1 1 0;
                min-width: 0;
                padding: 0.25rem 0.32rem;
                gap: 0.25rem;
                border-radius: 12px;
            }

            .resource-icon-small {
                font-size: 0.95rem;
            }

            .resource-value-small {
                font-size: 0.78rem;
            }

            .resource-rate-small {
                font-size: 0.58rem;
            }

            .bottom-panel {
                top: auto;
                right: 0.45rem;
                bottom: 3.8rem;
                width: min(86vw, 340px);
                max-height: 44vh;
                padding: 0.65rem;
                border-radius: 12px;
            }

            .panel-tabs {
                margin-bottom: 0.8rem;
            }

            .tab-button {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
            }

            .upgrades-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }

            .upgrade-card {
                padding: 0.8rem;
            }

            .progress-indicator {
                min-width: 260px;
                padding: 0.8rem 1rem;
                bottom: 32vh;
            }

            /* å›½å®¶é€‰æ‹©ç•Œé¢ä¼˜åŒ– */
            .country-screen {
                padding: 0.8rem 0.8rem 0.8rem 0.8rem;
                justify-content: flex-start;
                padding-top: max(0.9rem, calc(env(safe-area-inset-top) + 0.6rem));
            }

            .country-screen-title {
                font-size: 1.4rem;
                margin-bottom: 0.2rem;
            }

            .country-screen-subtitle {
                font-size: 0.75rem;
                margin-bottom: 0.6rem;
            }

            .country-grid {
                gap: 0.35rem;
                grid-template-columns: 1fr;
                max-width: 100%;
            }

            .country-card {
                padding: 0.4rem 0.48rem;
                min-height: 72px;
            }

            .country-flag {
                font-size: 1rem;
                margin-bottom: 0.12rem;
            }

            .country-name {
                font-size: 0.72rem;
                margin-bottom: 0.16rem;
            }

            .country-stats {
                font-size: 0.56rem;
                line-height: 1.08;
            }

            .country-tag {
                font-size: 0.48rem;
                padding: 0.06rem 0.28rem;
                margin-top: 0.14rem;
            }

            /* é¡¶éƒ¨è¿›åº¦æ¡ç§»åŠ¨ç«¯ä½ç½® */
            .top-progress-bar {
                bottom: 54px;
                width: 80%;
                min-width: 260px;
                padding: 0.4rem 0.8rem;
                font-size: 0.7rem;
            }

            .right-edge-actions {
                right: 0.45rem;
                top: 6.3rem;
                transform: none;
                gap: 0.35rem;
            }

            .level-action-btn {
                font-size: 0.64rem;
                padding: 0.26rem 0.58rem;
            }

            .mvp-meta {
                right: 0.45rem;
                bottom: 0.5rem;
                gap: 0.35rem;
            }

            .mvp-version-badge {
                font-size: 0.58rem;
                padding: 0.2rem 0.45rem;
            }

            .mvp-feedback-btn {
                font-size: 0.62rem;
                padding: 0.24rem 0.52rem;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== SVGå¤ªé˜³ç³»åŠ¨ç”»å±‚ï¼ˆå·²è¢« canvas æ¥ç®¡ï¼Œéšè—æ­¤å±‚ï¼‰===== */
        #solarSystemOverlay {
            display: none !important;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5;
            opacity: 1.0;
            transition: opacity 1.5s ease, filter 1.5s ease, transform 0.3s ease;
            perspective: 2000px;
            perspective-origin: center center;
            transform: rotateX(45deg) scale(0.6);  /* 45åº¦å€¾æ–œ */
            transform-style: preserve-3d;
        }
        
        #solarSystemSVG {
            width: 100%;
            height: 100%;
        }

        /* SVGå¤ªé˜³ç³»åŠ¨ç”»æ ·å¼ */
        .solar-orbit {
            fill: none;
            stroke: rgba(230, 230, 230, 0.3);
            stroke-width: 3;
        }
        
        .solar-sun {
            fill: url(#sun);
            filter: drop-shadow(0 0 50px orange);
        }
        
        .solar-planet {
            transform-origin: center;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
        }
        
        .solar-shadow {
            fill: url(#shadow);
        }
        

        
        /* æ ¹æ®ç§‘æŠ€ç­‰çº§è°ƒæ•´è§†è§’ï¼šä»åœ°çƒç‰¹å†™é€æ¸æ‹‰è¿œåˆ°å®Œæ•´å¤ªé˜³ç³» */
        #solarSystemOverlay.tech-level-0 {
            filter: brightness(1.0) saturate(0.9);
        }
        
        #solarSystemOverlay.tech-level-1 {
            filter: brightness(1.0) saturate(1.0) hue-rotate(5deg);
        }
        
        #solarSystemOverlay.tech-level-2 {
            filter: brightness(1.0) saturate(1.1) hue-rotate(10deg);
        }

        #solarSystemOverlay.tech-level-3 {
            filter: brightness(1.0) saturate(1.3) hue-rotate(15deg);
        }

        #solarSystemOverlay.tech-level-4 {
            filter: brightness(1.0) saturate(1.5) hue-rotate(20deg);
        }
        
        /* Lv4æ‰«æçº¿ç‰¹æ•ˆ */
        #solarSystemOverlay.tech-level-4::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(147, 112, 219, 0.03) 2px,
                rgba(147, 112, 219, 0.03) 4px
            );
            animation: scanlineMove 8s linear infinite;
            pointer-events: none;
        }
        
        @keyframes scanlineMove {
            0% { transform: translateY(0); }
            100% { transform: translateY(20px); }
        }

        @keyframes nebulaPulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }

        /* ===== CSSè¡Œæ˜Ÿå±‚ï¼ˆå åœ¨canvasä¸Šæ–¹ï¼Œé¿å¼€è·¨åŸŸé™åˆ¶ï¼‰===== */
        #planetLayer {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            pointer-events: none;   /* é»˜è®¤ä¸æ‹¦æˆªï¼Œè¡Œæ˜Ÿè‡ªå·±å¼€å¯ */
            z-index: 10;
        }

        .planet-div {
            position: absolute;
            border-radius: 50%;
            background: transparent;
            transform: translate(-50%, -50%);
            cursor: default;
            pointer-events: none;
            transition: filter 0.4s ease, opacity 0.6s ease, box-shadow 0.4s ease;
            border: none;
        }

        .planet-div.locked {
            pointer-events: none;
            opacity: 0;
            border-color: transparent;
        }

        /* ç§»é™¤æ‰€æœ‰å•ç‹¬æ˜Ÿçƒå›¾ç‰‡ï¼Œä½¿ç”¨å¤ªé˜³ç³»å›¾ä¸­çš„è¡Œæ˜Ÿ */
        .p-sun, .p-mercury, .p-venus, .p-earth, .p-moon, .p-mars, 
        .p-jupiter, .p-saturn, .p-uranus, .p-neptune {
            background: transparent;
        }
        
        /* å¤ªé˜³ç‰¹æ®Šå¤„ç†ï¼šæ— è¾¹æ¡†ï¼Œä¸å¯ç‚¹ */
        .p-sun {
            pointer-events: none;
            border: none;
        }

        /* è¡Œæ˜Ÿè‡ªè½¬åŠ¨ç”»å·²ç§»é™¤ - ä¿æŒæ¸…æ™°é™æ€å±•ç¤º */

        /* è§£é”æ—¶çš„å‡ºç°åŠ¨ç”» */
        @keyframes planetAppear {
            0%   { transform: translate(-50%,-50%) scale(0); opacity:0; }
            60%  { transform: translate(-50%,-50%) scale(1.15); }
            100% { transform: translate(-50%,-50%) scale(1);  opacity:1; }
        }
        .planet-div.appearing { animation: planetAppear 0.8s cubic-bezier(0.34,1.56,0.64,1) forwards; }

        /* ===== é€‰å›½å®¶å¼€åœºç•Œé¢ ===== */
        .country-screen {
            position: fixed;
            inset: 0;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 2rem;
            padding-top: max(1rem, calc(env(safe-area-inset-top) + 0.8rem));
            animation: fadeIn 1s ease;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .country-screen-title {
            font-family: var(--font-ui);
            font-size: 2.2rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .country-screen-subtitle {
            color: var(--text-gray);
            font-size: 1rem;
            margin-bottom: 2rem;
            text-align: center;
            font-style: italic;
            max-width: 500px;
            line-height: 1.6;
        }

        .country-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 1rem;
            width: 100%;
            max-width: 760px;
        }

        .country-card {
            background: rgba(15, 23, 42, 0.85);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            padding: 1.4rem 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            min-height: 260px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .country-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.75), rgba(15,23,42,0.85));
            opacity: 1;
            transition: opacity 0.3s;
            z-index: 1;
        }

        .country-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0,217,255,0.25);
        }

        .country-card:hover::before { opacity: 0.7; }

        .country-card.vip {
            border-color: rgba(251,191,36,0.4);
        }

        .country-card.vip:hover {
            border-color: var(--accent-gold);
            box-shadow: 0 10px 30px rgba(251,191,36,0.3);
        }

        .country-flag {
            font-size: 2.8rem;
            margin-bottom: 0.5rem;
            display: block;
            position: relative;
            z-index: 2;
        }

        .country-name {
            font-family: var(--font-ui);
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.8rem;
            color: var(--text-white);
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
        }

        .country-stats {
            font-size: 0.82rem;
            color: var(--text-gray);
            line-height: 1.7;
            position: relative;
            z-index: 2;
        }

        .country-stats span {
            display: block;
            text-shadow: 0 1px 4px rgba(0,0,0,0.7);
        }

        .country-stats .highlight {
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .country-tag {
            display: inline-block;
            margin-top: 0.6rem;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.72rem;
            font-weight: 700;
            position: relative;
            z-index: 2;
        }

        .tag-vip { background: rgba(251,191,36,0.2); color: var(--accent-gold); border: 1px solid rgba(251,191,36,0.4); }

        /* å›½å®¶ç‰¹å®šèƒŒæ™¯å›¾ç‰‡ */
        .country-usa { background-image: url('https://flagcdn.com/w640/us.png'); }
        .country-china { background-image: url('https://flagcdn.com/w640/cn.png'); }
        .country-russia { background-image: url('https://flagcdn.com/w640/ru.png'); }
        .country-germany { background-image: url('https://flagcdn.com/w640/de.png'); }
        .country-japan { background-image: url('https://flagcdn.com/w640/jp.png'); }
        .tag-event { background: rgba(168,85,247,0.2); color: var(--accent-purple); border: 1px solid rgba(168,85,247,0.4); }
        .tag-balanced { background: rgba(16,185,129,0.2); color: var(--accent-green); border: 1px solid rgba(16,185,129,0.4); }
    </style>
</head>
<body>
    <!-- å®‡å®™ç”»å¸ƒï¼ˆåªç»˜åˆ¶æ˜Ÿç©ºã€è½¨é“çº¿ã€å…‰è·¯ã€ç²’å­ï¼‰ -->
    <div class="universe-canvas">
        <canvas id="universeCanvas"></canvas>
    </div>

    <!-- SVGå¤ªé˜³ç³»åŠ¨ç”»å±‚ -->
    <div id="solarSystemOverlay" class="solar-overlay">
        <svg id="solarSystemSVG" style="fill-rule:evenodd" viewBox="0 0 25000 25000">
            <defs>
                <radialGradient id="sun">
                    <stop offset="30%" stop-color="yellow"/>
                    <stop offset="100%" stop-color="orange"/>
                </radialGradient>
                <radialGradient id="sunshine">
                    <stop offset="10%" stop-color="orange"/>
                    <stop offset="95%" stop-color="transparent"/>
                </radialGradient>
                <linearGradient id="shadow">
                    <stop offset="0" stop-color="transparent"/>
                    <stop offset="50%" stop-color="#000"/>
                </linearGradient>
                <linearGradient id="mercury-shadow">
                    <stop offset="50%" stop-color="transparent"/>
                    <stop offset="100%" stop-color="rgba(0,0,0,.5)"/>
                </linearGradient>
                <linearGradient id="venus-grad" x1="0" y1="0" x2="0" y2="100%">
                    <stop offset="30%" stop-color="#f0990e"/>
                    <stop offset="40%" stop-color="#fecb36"/>
                    <stop offset="60%" stop-color="#f0990e"/>
                    <stop offset="100%" stop-color="#f0990e"/>
                </linearGradient>
                <radialGradient id="earth-grad" fx="0.2" fy="0.2">
                    <stop offset="50%" stop-color="#009688"/>
                    <stop offset="60%" stop-color="#009688"/>
                    <stop offset="70%" stop-color="#0270e9"/>
                    <stop offset="100%" stop-color="#0270e9"/>
                </radialGradient>
                <radialGradient id="mars-grad" fx="0.3" fy="0.3">
                    <stop offset="60%" stop-color="#e25409"/>
                    <stop offset="65%" stop-color="#e25409"/>
                    <stop offset="100%" stop-color="#BF360C"/>
                </radialGradient>
                <linearGradient id="jupiter-grad" x1="0" y1="0" x2="0" y2="100%">
                    <stop offset="15%" stop-color="#d7b872"/>
                    <stop offset="25%" stop-color="#a24416"/>
                    <stop offset="30%" stop-color="#a24416"/>
                    <stop offset="40%" stop-color="#a6563e"/>
                    <stop offset="60%" stop-color="#a6563e"/>
                    <stop offset="80%" stop-color="#6f3620"/>
                    <stop offset="100%" stop-color="#d7b872"/>
                </linearGradient>
                <linearGradient id="saturn-grad" x1="0" x2="0" y1="0" y2="100%">
                    <stop offset="0%" stop-color="#ec9a22"/>
                    <stop offset="40%" stop-color="#d16c10"/>
                    <stop offset="55%" stop-color="#d16c10"/>
                    <stop offset="50%" stop-color="#ec9925"/>
                    <stop offset="70%" stop-color="#ec9925"/>
                    <stop offset="75%" stop-color="#d07b15"/>
                    <stop offset="100%" stop-color="#ec9a22"/>
                </linearGradient>
                <linearGradient id="uranus-grad" x1="0" y1="0" x2="0" y2="100%">
                    <stop offset="15%" stop-color="#199cdd"/>
                    <stop offset="25%" stop-color="#32b1fd"/>
                    <stop offset="30%" stop-color="#199cdd"/>
                    <stop offset="40%" stop-color="#32b1fd"/>
                    <stop offset="60%" stop-color="#199cdd"/>
                    <stop offset="80%" stop-color="#32b1fd"/>
                    <stop offset="100%" stop-color="#199cdd"/>
                </linearGradient>
                <linearGradient id="neptune-grad" x1="0" y1="0" x2="0" y2="100%">
                    <stop offset="0%" stop-color="#005de8"/>
                    <stop offset="25%" stop-color="#0747a3"/>
                    <stop offset="50%" stop-color="#287af7"/>
                    <stop offset="75%" stop-color="#0747a3"/>
                    <stop offset="100%" stop-color="#005de8"/>
                </linearGradient>
            </defs>
            <g>
                <circle class="solar-orbit" cx="50%" cy="50%" r="12000"/>
                <circle class="solar-orbit" cx="50%" cy="50%" r="10500"/>
                <circle class="solar-orbit" cx="50%" cy="50%" r="8000"/>
                <circle class="solar-orbit" cx="50%" cy="50%" r="5500"/>
                <circle class="solar-orbit" cx="50%" cy="50%" r="4100"/>
                <circle class="solar-orbit" cx="50%" cy="50%" r="3100"/>
                <circle class="solar-orbit" cx="50%" cy="50%" r="2000"/>
                <circle class="solar-orbit" cx="50%" cy="50%" r="1000"/>
                <circle class="solar-sun" cx="50%" cy="50%" r="1600"/>
                
                <g class="neptune-group">
                    <circle class="solar-planet" cx="50%" cy="50%" r="200" fill="url(#neptune-grad)"/>
                    <circle class="solar-shadow" cx="50%" cy="50%" r="200"/>
                </g>
                <g class="uranus-group">
                    <circle class="solar-planet" cx="50%" cy="50%" r="200" fill="url(#uranus-grad)"/>
                    <circle class="solar-shadow" cx="50%" cy="50%" r="200"/>
                </g>
                <g class="saturn-group">
                    <circle class="solar-planet" cx="50%" cy="50%" r="1100" fill="none" stroke="#bf4c0d" stroke-width="50"/>
                    <circle class="solar-shadow" cx="50%" cy="50%" r="1150"/>
                    <circle class="solar-planet" cx="50%" cy="50%" r="850" fill="none" stroke="#bf4c0d" stroke-width="300"/>
                    <circle class="solar-shadow" cx="50%" cy="50%" r="1000"/>
                    <circle class="solar-planet" cx="50%" cy="50%" r="400" fill="url(#saturn-grad)"/>
                    <circle class="solar-shadow" cx="50%" cy="50%" r="400"/>
                </g>
                <g class="jupiter-group">
                    <circle class="solar-planet" cx="50%" cy="50%" r="300" fill="url(#jupiter-grad)"/>
                    <circle class="solar-shadow" cx="50%" cy="50%" r="300"/>
                </g>
                <g class="mars-group">
                    <circle class="solar-planet" cx="50%" cy="50%" r="300" fill="url(#mars-grad)"/>
                    <circle class="solar-shadow" cx="50%" cy="50%" r="300"/>
                </g>
                <g class="earth-group">
                    <circle class="solar-orbit" cx="50%" cy="50%" r="500"/>
                    <g class="moon-group">
                        <circle class="solar-planet" cx="50%" cy="50%" r="50" fill="#E6E6E6"/>
                        <circle class="solar-shadow" cx="50%" cy="50%" r="50"/>
                    </g>
                    <circle class="solar-planet" cx="50%" cy="50%" r="300" fill="url(#earth-grad)"/>
                    <circle class="solar-shadow" cx="50%" cy="50%" r="300"/>
                </g>
                <g class="venus-group">
                    <circle class="solar-planet" cx="50%" cy="50%" r="200" fill="url(#venus-grad)"/>
                    <circle class="solar-shadow" cx="50%" cy="50%" r="200"/>
                </g>
                <g class="mercury-group">
                    <circle class="solar-planet" cx="50%" cy="50%" r="100" fill="#be9a60"/>
                    <circle cx="50%" cy="50%" r="100" fill="url(#mercury-shadow)"/>
                </g>
            </g>
        </svg>
    </div>

    <!-- CSSè¡Œæ˜Ÿå±‚ï¼ˆçœŸå®å›¾ç‰‡ï¼Œé¿å¼€Canvasè·¨åŸŸé™åˆ¶ï¼‰ -->
    <div id="planetLayer"></div>

    <!-- é€‰å›½å®¶å¼€åœºç•Œé¢ -->
    <div class="country-screen" id="countryScreen">
        
        <div class="country-screen-subtitle">
            "æˆ‘ä»¬é‡‡çŸ¿ï¼Œæˆ‘ä»¬æœé›†èƒ½æºï¼Œæˆ‘ä»¬å‘å±•ç§‘æŠ€ï¼Œæˆ‘ä»¬è¿ˆå‘é“¶æ²³"
        </div>
        <div class="country-grid">
            <div class="country-card country-usa vip" onclick="selectCountry('usa')">
                <span class="country-flag">ğŸ‡ºğŸ‡¸</span>
                <div class="country-name">ç¾å›½</div>
                <div class="country-stats">
                    <span>ğŸ’ åˆå§‹çŸ¿çŸ³ <b class="highlight">500</b></span>
                    <span>âš¡ èƒ½æº <b class="highlight">50</b></span>
                    <span>ğŸ‘Š ç‚¹å‡»åŠ› <b class="highlight">60</b></span>
                    <span class="country-tag tag-vip">â˜… VIP ä¼˜åŠ¿</span>
                </div>
            </div>
            <div class="country-card country-china" onclick="selectCountry('china')">
                <span class="country-flag">ğŸ‡¨ğŸ‡³</span>
                <div class="country-name">ä¸­å›½</div>
                <div class="country-stats">
                    <span>ğŸ’ åˆå§‹çŸ¿çŸ³ <b class="highlight">200</b></span>
                    <span>âš¡ èƒ½æº <b class="highlight">80</b></span>
                    <span>ğŸ‘Š ç‚¹å‡»åŠ› <b class="highlight">80</b></span>
                    <span class="country-tag tag-event">ç‹¬æœ‰äº‹ä»¶é“¾</span>
                </div>
            </div>
            <div class="country-card country-russia" onclick="selectCountry('russia')">
                <span class="country-flag">ğŸ‡·ğŸ‡º</span>
                <div class="country-name">ä¿„ç½—æ–¯</div>
                <div class="country-stats">
                    <span>ğŸ’ åˆå§‹çŸ¿çŸ³ <b class="highlight">400</b></span>
                    <span>âš¡ èƒ½æº <b class="highlight">60</b></span>
                    <span>ğŸ‘Š ç‚¹å‡»åŠ› <b class="highlight">60</b></span>
                    <span class="country-tag tag-balanced">å‡è¡¡å‘å±•</span>
                </div>
            </div>
            <div class="country-card country-germany" onclick="selectCountry('germany')">
                <span class="country-flag">ğŸ‡©ğŸ‡ª</span>
                <div class="country-name">å¾·å›½</div>
                <div class="country-stats">
                    <span>ğŸ’ åˆå§‹çŸ¿çŸ³ <b class="highlight">250</b></span>
                    <span>âš¡ èƒ½æº <b class="highlight">70</b></span>
                    <span>ğŸ‘Š ç‚¹å‡»åŠ› <b class="highlight">60</b></span>
                    <span class="country-tag tag-balanced">å·¥ä¸šå¼ºå›½</span>
                </div>
            </div>
            <div class="country-card country-japan" onclick="selectCountry('japan')">
                <span class="country-flag">ğŸ‡¯ğŸ‡µ</span>
                <div class="country-name">æ—¥æœ¬</div>
                <div class="country-stats">
                    <span>ğŸ’ åˆå§‹çŸ¿çŸ³ <b class="highlight">200</b></span>
                    <span>âš¡ èƒ½æº <b class="highlight">100</b></span>
                    <span>ğŸ‘Š ç‚¹å‡»åŠ› <b class="highlight">60</b></span>
                    <span class="country-tag tag-event">ç‹¬æœ‰äº‹ä»¶é“¾</span>
                </div>
            </div>
        </div>
    </div>

    <!-- UIå±‚ -->
    <div class="ui-overlay">
        <!-- é¡¶éƒ¨æ  -->
        <div class="top-bar">
            <div class="top-status-row">
                <div class="civilization-level" id="gameDate">ğŸ“… 2025å¹´1æœˆ</div>
                <div class="civilization-level" id="civLevel">ğŸŒ è¡Œæ˜Ÿæ–‡æ˜</div>
            </div>
            <div class="resources-compact">
                <div class="resource-compact">
                    <span class="resource-icon-small">ğŸ’</span>
                    <div>
                        <div class="resource-value-small" id="oreVal">0</div>
                        <div class="resource-rate-small" id="oreRate">+0/ç§’</div>
                    </div>
                </div>
                <div class="resource-compact">
                    <span class="resource-icon-small">âš¡</span>
                    <div>
                        <div class="resource-value-small" id="energyVal">0</div>
                        <div class="resource-rate-small" id="energyRate">+0/ç§’</div>
                    </div>
                </div>
                <div class="resource-compact">
                    <span class="resource-icon-small">ğŸ”¬</span>
                    <div>
                        <div class="resource-value-small" id="techVal">0</div>
                        <div class="resource-rate-small" id="techRate">+0/ç§’</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¿›åº¦æ¡ï¼šå›ºå®šåœ¨åº•éƒ¨é¢æ¿æ­£ä¸Šæ–¹ -->
        <div class="top-progress-bar">
            <div style="display:flex;align-items:center;gap:0.8rem;">
                <div id="progressTitle" style="font-family:var(--font-ui);font-size:0.75rem;font-weight:700;color:var(--accent-gold);white-space:nowrap;flex-shrink:0;">ğŸ¯ è·ç¦»åœ°æœˆç³»ç»Ÿ</div>
                <div style="flex:1;height:10px;background:rgba(0,0,0,0.5);border-radius:5px;overflow:hidden;">
                    <div id="progressBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent-cyan),var(--accent-purple),var(--accent-gold));border-radius:5px;transition:width 0.5s ease;box-shadow:0 0 8px rgba(0,217,255,0.5);"></div>
                </div>
                <div id="progressPercent" style="font-family:var(--font-mono);font-size:0.75rem;color:var(--text-gray);white-space:nowrap;flex-shrink:0;">0%</div>
            </div>
        </div>

        <div class="right-edge-actions">
            <button class="level-action-btn" onclick="openRightPanel('tech')">ğŸ”¬ ç§‘æŠ€</button>
            <button class="level-action-btn" onclick="openRightPanel('special')">ğŸ—ï¸ ä¼Ÿå¤§å·¥ç¨‹</button>
        </div>

        <!-- æç¤ºæ–‡æœ¬å·²ç§»é™¤ï¼Œç”±ç‚¹å‡»åé¦ˆä»£æ›¿ -->

        <!-- åº•éƒ¨é¢æ¿ -->
        <div class="bottom-panel">
            <div class="panel-topbar">
                <div class="panel-tabs">
                    <button class="tab-button active" data-tab="mining">ğŸ’ æ§½ä½å·¥å‚</button>
                    <button class="tab-button" data-tab="energy">âš¡ è‡ªåŠ¨èƒ½æº</button>
                    <button class="tab-button" data-tab="tech">ğŸ”¬ ç§‘æŠ€ç³»ç»Ÿ</button>
                    <button class="tab-button" data-tab="special">âœ¨ ç‰¹æ®Š</button>
                </div>
                <button class="panel-close-btn" onclick="closeRightPanel()">âœ• å…³é—­</button>
            </div>

            <div class="tab-content active" id="tab-mining">
                <div class="upgrades-grid" id="miningGrid"></div>
            </div>
            <div class="tab-content" id="tab-energy">
                <div class="upgrades-grid" id="energyGrid"></div>
            </div>
            <div class="tab-content" id="tab-tech">
                <div class="upgrades-grid" id="techGrid"></div>
            </div>
            <div class="tab-content" id="tab-special">
                <div class="upgrades-grid" id="specialGrid"></div>
            </div>
        </div>

        <div class="mvp-meta">
            <a class="mvp-feedback-btn" href="https://gameart.top" target="_blank" rel="noopener noreferrer">ğŸ  é¦–é¡µ</a>
            <button class="mvp-feedback-btn" onclick="resetGame()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            <button class="mvp-feedback-btn" onclick="testTechLevel()">ğŸ§ª æµ‹è¯•ç§‘æŠ€ç­‰çº§</button>
            <a class="mvp-feedback-btn" href="mailto:258775554@qq.com">ğŸ’¬ åé¦ˆé‚®ç®±</a>
            <a class="mvp-feedback-btn" href="tel:15221056162">ğŸ“ åé¦ˆç”µè¯</a>
        </div>
    </div>

    <div class="slot-build-modal" id="slotBuildModal" onclick="if(event.target===this) closeSlotBuildMenu()">
        <div class="slot-build-box">
            <div class="slot-build-title" id="slotBuildTitle">ğŸ§© æ§½ä½éƒ¨ç½²</div>
            <div class="slot-build-desc" id="slotBuildDesc">é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œ</div>
            <div class="slot-build-actions" id="slotBuildActions"></div>
            <button class="slot-build-close" onclick="closeSlotBuildMenu()">å…³é—­</button>
        </div>
    </div>

    <script src="battle.js"></script>
    <script src="scene.js"></script>
    <script>
        // æ¸¸æˆçŠ¶æ€
        const game = {
            ore: 0,           // çŸ¿çŸ³ï¼ˆåŸºç¡€èµ„æºï¼Œç‚¹å‡»å’Œå·¥å‚äº§å‡ºï¼‰
            energy: 0,        // èƒ½æºï¼ˆç”¨çŸ¿çŸ³ç”Ÿäº§ï¼‰
            tech: 0,          // ç§‘æŠ€ç‚¹ï¼ˆç”¨èƒ½æºé©±åŠ¨ï¼‰
            techLevel: 0,     // ç§‘æŠ€ç­‰çº§ 0-4
            startYear: 2025,
            calendarMonthsElapsed: 0,
            baseClickPower: 100,
            clickPower: 100,  // ç‚¹å‡»è·å¾—çŸ¿çŸ³
            orePerSec: 0,     // çŸ¿çŸ³äº§é‡
            energyPerSec: 0,  // èƒ½æºäº§é‡
            techPerSec: 0,    // ç§‘æŠ€äº§é‡
            totalEarned: 0,
            totalClicks: 0,
            currentStage: 0,
            lastSaveTime: Date.now(),
            unlockedPlanets: ['earth'],
            planetSlots: null,
            slotLayout: null,
            researchPowerNeed: 0,
            robotPowerNeed: 0,
            robotSupportCap: 0,
            robotOverCap: 0,
            robotPenalty: 1,
            marsBattleWon: false,
            marsBattlePhase: 0,
            earthClickCount: 0,
            earthConquestLevel: 0,
            moonClickCount: 0,
            venusClickCount: 0,
            mercuryClickCount: 0,
            marsClickCount: 0,
            jupiterClickCount: 0,
            saturnClickCount: 0,
            upgrades: { mining: [], energy: [], tech: [], special: [] }
        };
        window.game = game;  // ä¾› scene.js è®¿é—®

        // æ–‡æ˜é˜¶æ®µ
        const stages = [
            { id: 0, name: 'ğŸŒ è¡Œæ˜Ÿæ–‡æ˜', desc: 'äººç±»æ–‡æ˜çš„èµ·ç‚¹', threshold: 0, nextThreshold: 200, view: 'earth' },
            { id: 1, name: 'ğŸŒ™ åœ°æœˆç³»ç»Ÿ', desc: 'æœˆçƒæˆä¸ºäººç±»ç¬¬äºŒå®¶å›­', threshold: 200, nextThreshold: 1000, view: 'inner' },
            { id: 2, name: 'ğŸª å†…è¡Œæ˜Ÿå¾æœ', desc: 'æ°´æ˜Ÿã€é‡‘æ˜Ÿã€ç«æ˜Ÿæ®–æ°‘å®Œæˆ', threshold: 1000, nextThreshold: 5000, view: 'inner' },
            { id: 3, name: 'â˜€ï¸ å¤ªé˜³ç³»éœ¸ä¸»', desc: 'æŒæ§å…«å¤§è¡Œæ˜Ÿ', threshold: 5000, nextThreshold: 25000, view: 'solar' },
            { id: 4, name: 'ğŸŒŒ é“¶æ²³æ¢ç´¢è€…', desc: 'æ˜Ÿé™…æ—¶ä»£æ¥ä¸´', threshold: 25000, nextThreshold: Infinity, view: 'galaxy' }
        ];

        // è¡Œæ˜Ÿæ•°æ®
        // è¡Œæ˜Ÿæ•°æ®ï¼ˆè·ç¦»/è§’åº¦å†³å®šå¸ƒå±€ï¼ŒcssClasså¯¹åº”çœŸå®å›¾ç‰‡ï¼‰
        const planets = [
            { id: 'sun',     name: 'å¤ªé˜³',   radius: 44, color: '#FDB813', unlockStage: 0, isSun: true,  cssClass: 'p-sun',     clickMulti: 0  },
            { id: 'mercury', name: 'æ°´æ˜Ÿ',   distance: 105, angle: 15,  radius: 13, color: '#8C7853', unlockStage: 2, cssClass: 'p-mercury', clickMulti: 2  },
            { id: 'venus',   name: 'é‡‘æ˜Ÿ',   distance: 148, angle: 55,  radius: 18, color: '#E8C07D', unlockStage: 2, cssClass: 'p-venus',   clickMulti: 3  },
            { id: 'earth',   name: 'åœ°çƒ',   distance: 192, angle: 100, radius: 16, color: '#4A90E2', unlockStage: 0, cssClass: 'p-earth',   clickMulti: 1  },
            { id: 'moon',    name: 'æœˆçƒ',   distance: 222, angle: 113, radius: 9,  color: '#CCCCCC', unlockStage: 1, cssClass: 'p-moon',    clickMulti: 2  },
            { id: 'mars',    name: 'ç«æ˜Ÿ',   distance: 252, angle: 148, radius: 17, color: '#D94A2E', unlockStage: 2, cssClass: 'p-mars',    clickMulti: 4  },
            { id: 'jupiter', name: 'æœ¨æ˜Ÿ',   distance: 328, angle: 195, radius: 30, color: '#C88B3A', unlockStage: 3, cssClass: 'p-jupiter', clickMulti: 8  },
            { id: 'saturn',  name: 'åœŸæ˜Ÿ',   distance: 385, angle: 238, radius: 25, color: '#FAD5A5', unlockStage: 3, cssClass: 'p-saturn',  clickMulti: 10 },
            { id: 'uranus',  name: 'å¤©ç‹æ˜Ÿ', distance: 430, angle: 278, radius: 19, color: '#4FD5D6', unlockStage: 3, cssClass: 'p-uranus',  clickMulti: 12 },
            { id: 'neptune', name: 'æµ·ç‹æ˜Ÿ', distance: 468, angle: 320, radius: 17, color: '#4166F5', unlockStage: 3, cssClass: 'p-neptune', clickMulti: 15 }
        ];
        window.planets = planets;  // ä¾› scene.js è®¿é—®

        // å‡çº§é…ç½® - æ–°çš„èµ„æºé“¾æ¡ï¼šçŸ¿çŸ³â†’èƒ½æºâ†’ç§‘æŠ€
        const upgradesConfig = {
            // é‡‡çŸ¿è®¾æ–½ï¼šæ§½ä½å»ºé€ ï¼ˆåœ°çƒ10æ ¼ã€æœˆçƒ1æ ¼ã€ç«æ˜Ÿ6æ ¼ï¼‰
            mining: [
                { id: 'mf1', name: 'è‡ªåŠ¨å·¥å‚', icon: 'ğŸ­', baseProduction: 4, baseCost: 120, costMult: 1.35, costType: 'ore', buildingKey: 'autoFactory' },
                { id: 'mr1', name: 'æœºå™¨äººå†›å›¢', icon: 'ğŸ¤–', clickBonusMult: 1.35, baseCost: 180, costMult: 1.4, costType: 'ore', buildingKey: 'robotLegion' }
            ],
            // èƒ½æºè®¾æ–½ï¼šæ¶ˆè€—çŸ¿çŸ³ï¼Œäº§å‡ºèƒ½æº
            energy: [
                { id: 'e1', name: 'æ ¸ç”µç«™', icon: 'â˜¢ï¸', baseProduction: 3, baseCost: 100, costMult: 1.14, costType: 'ore', outputType: 'energy' },
                { id: 'e2', name: 'æ ¸èšå˜å †', icon: 'âš¡', baseProduction: 18, baseCost: 800, costMult: 1.14, costType: 'ore', outputType: 'energy' },
                { id: 'e3', name: 'å«æ˜Ÿå¤ªé˜³èƒ½', icon: 'ğŸ›°ï¸', baseProduction: 120, baseCost: 5000, costMult: 1.14, costType: 'ore', outputType: 'energy' },
                { id: 'e4', name: 'åç‰©è´¨å¼•æ“', icon: 'âœ¨', baseProduction: 800, baseCost: 30000, costMult: 1.14, costType: 'ore', outputType: 'energy' }
            ],
            // ç§‘æŠ€ç³»ç»Ÿï¼šæ¶ˆè€—ç§‘ç ”å€¼ï¼Œè§£é”ç§‘æŠ€ç­‰çº§ï¼ˆæ¯ä¸ªåªèƒ½è´­ä¹°ä¸€æ¬¡ï¼‰
            tech: [
                { id: 't1', name: 'åœ°æœˆå¼•åŠ›æ¡¥', icon: 'ğŸŒ™', techLevel: 1, baseCost: 100, desc: 'è¿æ¥åœ°çƒä¸æœˆçƒï¼Œå¼€å¯æ–‡æ˜æ–°çºªå…ƒ', costType: 'tech', unlocked: false },
                { id: 't2', name: 'å¤ªé˜³ç³»å¼•åŠ›æ¡¥', icon: 'â˜€ï¸', techLevel: 2, baseCost: 300, desc: 'æŒæ§å¤ªé˜³ç³»å†…è¡Œæ˜Ÿï¼Œæ–‡æ˜è·¨è¶Šå¼å‘å±•', costType: 'tech', unlocked: false },
                { id: 't3', name: 'æ˜Ÿé™…å¼•åŠ›æ¡¥', icon: 'ğŸŒ ', techLevel: 3, baseCost: 1500, desc: 'ç©¿è¶Šæ’æ˜Ÿç³»é—´çš„è™šç©ºï¼Œå¼€åˆ›æ˜Ÿé™…æ–‡æ˜æ–°çºªå…ƒ', costType: 'tech', unlocked: false },
                { id: 't4', name: 'é“¶æ²³ç³»å¼•åŠ›æ¡¥', icon: 'ğŸŒŒ', techLevel: 4, baseCost: 8000, desc: 'é“¶æ²³æ–‡æ˜å·…å³°ï¼Œå¾æœæ˜Ÿè¾°å¤§æµ·', costType: 'tech', unlocked: false }
            ],
            special: [
                { id: 'sp1', name: 'æ˜Ÿé“¾', icon: 'ğŸ›°ï¸', baseProduction: 32, baseCost: 380, costMult: 1.13, costType: 'ore', bonus: 'click' },
                { id: 'sp2', name: 'å¤ªç©ºå…‰ä¼å¤§é™†', icon: 'â˜€ï¸', baseProduction: 90, baseCost: 6800, costMult: 1.16, costType: 'ore', bonus: 'energyFlat' },
                { id: 'sp3', name: 'æˆ´æ£®çƒ', icon: 'ğŸŒŸ', baseProduction: 260, baseCost: 42000, costMult: 1.18, costType: 'energy', bonus: 'energyFlat' },
                { id: 'sp4', name: 'æœˆé¢æ°¦-3ååº”å †ç¾¤', icon: 'ğŸŒ•', baseProduction: 520, baseCost: 165000, costMult: 1.21, costType: 'ore', bonus: 'energyFlat' },
                { id: 'sp5', name: 'è½¨é“é‡å­é€šä¿¡ç½‘', icon: 'ğŸ“¡', baseProduction: 0, baseCost: 320000, costMult: 1.24, costType: 'energy', bonus: 'techBoost', techBoostValue: 1.22 }
            ]
        };

        // æ•°å­—æ ¼å¼åŒ–
        function formatNumber(num) {
            if (num < 1000) return Math.floor(num);
            if (num < 1000000) return (num / 1000).toFixed(1) + 'K';
            if (num < 1000000000) return (num / 1000000).toFixed(2) + 'M';
            return (num / 1000000000).toFixed(2) + 'B';
        }

        function getCalendarText() {
            const startYear = Number(game.startYear) || 2025;
            const elapsed = Math.max(0, Number(game.calendarMonthsElapsed) || 0);
            const monthIndex = Math.floor(elapsed);
            const year = startYear + Math.floor(monthIndex / 12);
            const month = (monthIndex % 12) + 1;
            const monthText = String(month).padStart(2, '0');
            return `ğŸ“… ${year}.${monthText}`;
        }

        const planetSlotRules = {
            earth: { name: 'åœ°çƒ', total: 8, unlockTech: 0 },
            moon: { name: 'æœˆçƒ', total: 1, unlockTech: 1 },
            venus: { name: 'é‡‘æ˜Ÿ', total: 1, unlockTech: 1 },
            mercury: { name: 'æ°´æ˜Ÿ', total: 1, unlockTech: 1 },
            mars: { name: 'ç«æ˜Ÿ', total: 6, unlockTech: 2 },
            jupiter: { name: 'æœ¨æ˜Ÿ', total: 1, unlockTech: 2 },
            saturn: { name: 'åœŸæ˜Ÿ', total: 1, unlockTech: 2 }
        };

        const earthConquestMilestones = [5, 10, 15, 20];
        const marsWarTargets = {
            clicks: 35,
            marsRobots: 2,
            totalRobots: 6
        };
        const outerConquestTargets = {
            jupiter: 8,
            saturn: 10
        };
        const earthConquestMessages = [
            'æ­å–œå¾æœäº†éæ´²æ²™æ¼ ',
            'æ­å–œå¾æœäº†å—æ',
            'æ­å–œå¾æœäº†æµ·åº•',
            'æ­å–œå¾æœäº†åœ°å¿ƒ'
        ];

        function getPlanetTotalSlots(planetId) {
            const baseTotal = planetSlotRules[planetId]?.total || 0;
            if (planetId !== 'earth') return baseTotal;
            const unlockedExtra = Math.max(0, Math.min(4, Math.floor(Number(game.earthConquestLevel) || 0)));
            return Math.min(baseTotal, 4 + unlockedExtra);
        }

        function getDefaultPlanetSlots() {
            return {
                earth: { autoFactory: 1, robotLegion: 1 },
                moon: { autoFactory: 0, robotLegion: 0 },
                venus: { autoFactory: 0, robotLegion: 0 },
                mercury: { autoFactory: 0, robotLegion: 0 },
                mars: { autoFactory: 0, robotLegion: 0 },
                jupiter: { autoFactory: 0, robotLegion: 0 },
                saturn: { autoFactory: 0, robotLegion: 0 }
            };
        }

        function getDefaultSlotLayout() {
            return {
                earth: ['autoFactory', 'robotLegion', null, null, null, null, null, null],
                moon: [null],
                venus: [null],
                mercury: [null],
                mars: [null, null, null, null, null, null],
                jupiter: [null],
                saturn: [null]
            };
        }

        function normalizePlanetSlots(rawSlots = null) {
            const defaults = getDefaultPlanetSlots();
            const normalized = {};
            Object.keys(planetSlotRules).forEach(planetId => {
                const source = rawSlots?.[planetId] || {};
                const autoFactory = Math.max(0, Number(source.autoFactory));
                const robotLegion = Math.max(0, Number(source.robotLegion));
                const fallback = defaults[planetId];
                normalized[planetId] = {
                    autoFactory: Number.isFinite(autoFactory) ? Math.floor(autoFactory) : fallback.autoFactory,
                    robotLegion: Number.isFinite(robotLegion) ? Math.floor(robotLegion) : fallback.robotLegion
                };

                const maxTotal = planetSlotRules[planetId].total;
                while (normalized[planetId].autoFactory + normalized[planetId].robotLegion > maxTotal) {
                    if (normalized[planetId].robotLegion > 0) {
                        normalized[planetId].robotLegion--;
                    } else if (normalized[planetId].autoFactory > 0) {
                        normalized[planetId].autoFactory--;
                    } else {
                        break;
                    }
                }
            });
            return normalized;
        }

        function normalizeSlotLayout(rawLayout = null, normalizedSlots = null, savedUpgrades = null) {
            const layout = {};
            const slots = normalizedSlots || normalizePlanetSlots();
            const energyTotal = (savedUpgrades?.energy || game.upgrades?.energy || []).reduce((sum, item) => sum + (item.level || 0), 0);

            Object.keys(planetSlotRules).forEach(planetId => {
                const total = planetSlotRules[planetId].total;
                const sourceArr = Array.isArray(rawLayout?.[planetId]) ? rawLayout[planetId] : null;
                const arr = new Array(total).fill(null);

                if (sourceArr) {
                    for (let i = 0; i < total; i++) {
                        const value = sourceArr[i];
                        const isKnownType = value === 'autoFactory' || value === 'robotLegion' || value === 'energyStation' || value === 'researchCenter';
                        arr[i] = isKnownType && isBuildingAllowedOnPlanet(planetId, value) ? value : null;
                    }
                } else {
                    let cursor = 0;
                    const autoCount = slots[planetId]?.autoFactory || 0;
                    const robotCount = slots[planetId]?.robotLegion || 0;
                    for (let i = 0; i < autoCount && cursor < total; i++) {
                        if (!isBuildingAllowedOnPlanet(planetId, 'autoFactory')) break;
                        arr[cursor++] = 'autoFactory';
                    }
                    for (let i = 0; i < robotCount && cursor < total; i++) {
                        if (!isBuildingAllowedOnPlanet(planetId, 'robotLegion')) break;
                        arr[cursor++] = 'robotLegion';
                    }
                    if (planetId === 'earth') {
                        for (let i = 0; i < energyTotal && cursor < total; i++, cursor++) arr[cursor] = 'energyStation';
                    }
                }

                layout[planetId] = arr;
            });

            return layout;
        }

        function recountPlanetSlotsFromLayout() {
            const next = {};
            Object.keys(planetSlotRules).forEach(planetId => {
                const arr = getPlanetSlotAssignments(planetId);
                next[planetId] = {
                    autoFactory: arr.filter(item => item === 'autoFactory').length,
                    robotLegion: arr.filter(item => item === 'robotLegion').length
                };
            });
            game.planetSlots = next;
        }

        function isPlanetConquestUnlocked(planetId) {
            if (planetId === 'moon') {
                const moonBridge = game.upgrades?.tech?.find(item => item.id === 't1');
                return !!moonBridge?.unlocked && (Number(game.moonClickCount) || 0) >= 5;
            }
            if (planetId === 'venus') {
                return (Number(game.venusClickCount) || 0) >= 5;
            }
            if (planetId === 'mercury') {
                return (Number(game.mercuryClickCount) || 0) >= 10;
            }
            if (planetId === 'mars') {
                return !!game.marsBattleWon;
            }
            if (planetId === 'jupiter') {
                return (Number(game.jupiterClickCount) || 0) >= outerConquestTargets.jupiter;
            }
            if (planetId === 'saturn') {
                return (Number(game.saturnClickCount) || 0) >= outerConquestTargets.saturn;
            }
            return true;
        }

        function isSlotPlanetUnlocked(planetId) {
            const rule = planetSlotRules[planetId];
            if (!rule) return false;
            const techUnlocked = (game.techLevel || 0) >= rule.unlockTech;
            if (!techUnlocked) return false;
            return isPlanetConquestUnlocked(planetId);
        }

        function getPlanetUsedSlots(planetId) {
            const arr = getPlanetSlotAssignments(planetId);
            return arr.filter(item => !!item).length;
        }

        function getPlanetEnergyStationCount(planetId) {
            const arr = getPlanetSlotAssignments(planetId);
            return arr.filter(item => item === 'energyStation').length;
        }

        function getPlanetSlotAssignments(planetId) {
            const total = getPlanetTotalSlots(planetId);
            if (!isSlotPlanetUnlocked(planetId)) {
                return new Array(total).fill(null);
            }
            const arr = game.slotLayout?.[planetId] || [];
            return [...arr.slice(0, total), ...new Array(Math.max(0, total - arr.length)).fill(null)];
        }

        function getBuildingCount(buildingKey) {
            return Object.keys(planetSlotRules).reduce((sum, planetId) => {
                return sum + getPlanetSlotAssignments(planetId).filter(item => item === buildingKey).length;
            }, 0);
        }

        function getResearchCenterCount() {
            return Object.keys(planetSlotRules).reduce((sum, planetId) => {
                return sum + getPlanetSlotAssignments(planetId).filter(item => item === 'researchCenter').length;
            }, 0);
        }

        function getUnlockedSlotStats() {
            const values = { total: 0, used: 0 };
            Object.keys(planetSlotRules).forEach(planetId => {
                if (!isSlotPlanetUnlocked(planetId)) return;
                values.total += getPlanetTotalSlots(planetId);
                values.used += getPlanetUsedSlots(planetId);
            });
            return values;
        }

        function isBuildingAllowedOnPlanet(planetId, buildingKey) {
            if (planetId === 'venus') {
                return buildingKey === 'robotLegion' || buildingKey === 'energyStation';
            }
            return buildingKey === 'autoFactory' || buildingKey === 'robotLegion' || buildingKey === 'energyStation' || buildingKey === 'researchCenter';
        }

        function getNextPlacementPlanet(buildingKey = null) {
            const order = ['earth', 'moon', 'venus', 'mercury', 'mars', 'jupiter', 'saturn'];
            for (const planetId of order) {
                if (!isSlotPlanetUnlocked(planetId)) continue;
                if (buildingKey && !isBuildingAllowedOnPlanet(planetId, buildingKey)) continue;
                if (getPlanetUsedSlots(planetId) < getPlanetTotalSlots(planetId)) {
                    return planetId;
                }
            }
            return null;
        }

        function syncMiningLevelsWithSlots() {
            recountPlanetSlotsFromLayout();
            const autoFactory = game.upgrades.mining.find(item => item.id === 'mf1');
            const robotLegion = game.upgrades.mining.find(item => item.id === 'mr1');
            if (autoFactory) autoFactory.level = getBuildingCount('autoFactory');
            if (robotLegion) robotLegion.level = getBuildingCount('robotLegion');
        }

        function placeMiningBuilding(buildingKey) {
            const nextPlanet = getNextPlacementPlanet(buildingKey);
            if (!nextPlanet) return null;
            const assignments = getPlanetSlotAssignments(nextPlanet);
            const firstEmpty = assignments.findIndex(item => !item);
            if (firstEmpty < 0) return null;
            game.slotLayout[nextPlanet][firstEmpty] = buildingKey;
            syncMiningLevelsWithSlots();
            return nextPlanet;
        }

        function getMiningUpgradeByBuildingKey(buildingKey) {
            return game.upgrades.mining.find(item => item.buildingKey === buildingKey);
        }

        function getMiningBuildCost(buildingKey) {
            const upgrade = getMiningUpgradeByBuildingKey(buildingKey);
            if (!upgrade) return Infinity;
            return Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult || 1.12, upgrade.level));
        }

        function getEnergyBuildCost() {
            const energyUpgrade = game.upgrades.energy.find(item => item.id === 'e1');
            if (!energyUpgrade) return Infinity;
            return Math.floor(energyUpgrade.baseCost * Math.pow(energyUpgrade.costMult || 1.12, energyUpgrade.level));
        }

        function placeMiningBuildingAtSlot(planetId, slotIndex, buildingKey) {
            if (!isSlotPlanetUnlocked(planetId)) return false;
            if (!isBuildingAllowedOnPlanet(planetId, buildingKey)) return false;
            const total = getPlanetTotalSlots(planetId);
            if (slotIndex < 0 || slotIndex >= total) return false;
            const assignments = getPlanetSlotAssignments(planetId);
            if (assignments[slotIndex]) return false;
            const cost = getMiningBuildCost(buildingKey);
            if (!Number.isFinite(cost) || game.ore < cost) return false;

            game.ore -= cost;
            game.slotLayout[planetId][slotIndex] = buildingKey;
            syncMiningLevelsWithSlots();
            updateProduction();
            renderUpgrades();
            updateUI();
            return true;
        }

        function removeBuildingFromSlot(planetId, slotIndex) {
            if (!isSlotPlanetUnlocked(planetId)) return false;
            const total = getPlanetTotalSlots(planetId);
            if (slotIndex < 0 || slotIndex >= total) return false;
            const assignments = getPlanetSlotAssignments(planetId);
            const slotType = assignments[slotIndex];
            if (!slotType) return false;

            game.slotLayout[planetId][slotIndex] = null;

            if (slotType === 'autoFactory' || slotType === 'robotLegion' || slotType === 'researchCenter') {
                // ç”± slotLayout è‡ªåŠ¨å›ç®—
            } else if (slotType === 'energyStation') {
                const target = [...game.upgrades.energy].reverse().find(item => item.level > 0);
                if (!target) return false;
                target.level -= 1;
            } else {
                return false;
            }

            syncMiningLevelsWithSlots();
            updateProduction();
            renderUpgrades();
            updateUI();
            return true;
        }

        function placeEnergyStationAtSlot(planetId, slotIndex) {
            if (!isBuildingAllowedOnPlanet(planetId, 'energyStation')) return false;
            if (!isSlotPlanetUnlocked(planetId)) return false;
            const total = getPlanetTotalSlots(planetId);
            if (slotIndex < 0 || slotIndex >= total) return false;
            const assignments = getPlanetSlotAssignments(planetId);
            if (assignments[slotIndex]) return false;

            const energyUpgrade = game.upgrades.energy.find(item => item.id === 'e1');
            if (!energyUpgrade) return false;
            const cost = getEnergyBuildCost();
            if (!Number.isFinite(cost) || game.ore < cost) return false;

            game.ore -= cost;
            energyUpgrade.level += 1;
            game.slotLayout[planetId][slotIndex] = 'energyStation';
            syncMiningLevelsWithSlots();
            updateProduction();
            renderUpgrades();
            updateUI();
            return true;
        }

        function getSlotLabel(slotType) {
            if (slotType === 'autoFactory') return 'ğŸ­ è‡ªåŠ¨å·¥å‚';
            if (slotType === 'robotLegion') return 'ğŸ¤– æœºå™¨äººå†›å›¢';
            if (slotType === 'energyStation') return 'âš¡ èƒ½æºç”µç«™';
            if (slotType === 'researchCenter') return 'ğŸ”¬ ç§‘ç ”ä¸­å¿ƒ';
            return 'ç©ºæ§½';
        }

        function getResearchCenterBuildCost() {
            const count = getResearchCenterCount();
            return Math.floor(260 * Math.pow(1.22, count));
        }

        function placeResearchCenterAtSlot(planetId, slotIndex) {
            if (!isSlotPlanetUnlocked(planetId)) return false;
            if (!isBuildingAllowedOnPlanet(planetId, 'researchCenter')) return false;
            const total = getPlanetTotalSlots(planetId);
            if (slotIndex < 0 || slotIndex >= total) return false;
            const assignments = getPlanetSlotAssignments(planetId);
            if (assignments[slotIndex]) return false;

            const cost = getResearchCenterBuildCost();
            if (!Number.isFinite(cost) || game.ore < cost) return false;

            game.ore -= cost;
            game.slotLayout[planetId][slotIndex] = 'researchCenter';
            syncMiningLevelsWithSlots();
            updateProduction();
            renderUpgrades();
            updateUI();
            return true;
        }

        function getFirstEmptySlotIndex(planetId) {
            const assignments = getPlanetSlotAssignments(planetId);
            return assignments.findIndex(item => !item);
        }

        function getFirstFilledSlotIndex(planetId) {
            const assignments = getPlanetSlotAssignments(planetId);
            return assignments.findIndex(item => !!item);
        }

        function openPlanetSlotMenu(planetId) {
            if (!isSlotPlanetUnlocked(planetId)) return;
            const emptyIndex = getFirstEmptySlotIndex(planetId);
            if (emptyIndex >= 0) {
                openSlotBuildMenu(planetId, emptyIndex);
                return;
            }
            const filledIndex = getFirstFilledSlotIndex(planetId);
            if (filledIndex >= 0) {
                openSlotBuildMenu(planetId, filledIndex);
            }
        }

        function updateLevelActionHud() {
            const moonBridge = game.upgrades?.tech?.find(item => item.id === 't1');
            const solarBridge = game.upgrades?.tech?.find(item => item.id === 't2');
            const moonBridgeUnlocked = !!moonBridge?.unlocked;
            const solarBridgeUnlocked = !!solarBridge?.unlocked;
            const researchCenterCount = getResearchCenterCount();
            const energyStationCount = getBuildingCount('energyStation');
            const moonRobotCount = getPlanetSlotAssignments('moon').filter(item => item === 'robotLegion').length;
            const moonClicks = Math.max(0, Number(game.moonClickCount) || 0);
            const venusClicks = Math.max(0, Number(game.venusClickCount) || 0);
            const mercuryClicks = Math.max(0, Number(game.mercuryClickCount) || 0);

            const canStartMarsBattle = game.currentStage === 2
                && researchCenterCount >= 1
                && energyStationCount >= 2
                && moonBridgeUnlocked
                && moonClicks >= 5
                && moonRobotCount >= 1
                && venusClicks >= 5
                && mercuryClicks >= 10
                && solarBridgeUnlocked
                && !game.marsBattleWon;

            if (window.BattleSystem && typeof window.BattleSystem.setVisible === 'function') {
                window.BattleSystem.setVisible(canStartMarsBattle);
            }
        }

        function buildUpgradesState(savedUpgrades = null) {
            const normalized = { mining: [], energy: [], tech: [], special: [] };
            for (let category in upgradesConfig) {
                const savedList = Array.isArray(savedUpgrades?.[category]) ? savedUpgrades[category] : [];
                upgradesConfig[category].forEach(config => {
                    const savedItem = savedList.find(item => item.id === config.id) || {};
                    const item = {
                        ...config,
                        category,
                        level: Math.max(0, Number(savedItem.level) || 0)
                    };
                    if (category === 'tech') {
                        item.unlocked = !!savedItem.unlocked;
                    }
                    normalized[category].push(item);
                });
            }
            return normalized;
        }

        // åˆå§‹åŒ–å‡çº§
        function initUpgrades() {
            game.upgrades = buildUpgradesState();
            game.planetSlots = normalizePlanetSlots();
            game.slotLayout = normalizeSlotLayout(null, game.planetSlots, game.upgrades);
            syncMiningLevelsWithSlots();
        }

        function renderUpgradeCategory(category) {
            const container = document.getElementById(category + 'Grid');
            if (!container || !Array.isArray(game.upgrades?.[category])) return;
            container.innerHTML = '';

            if (category === 'mining') {
                const slotStats = getUnlockedSlotStats();
                const summary = document.createElement('div');
                summary.className = 'upgrade-card';
                summary.innerHTML = `
                    <div class="upgrade-card-header">
                        <span class="upgrade-name">ğŸ§© æ˜Ÿçƒæ§½ä½éƒ¨ç½²</span>
                        <span class="upgrade-level-badge">${slotStats.used}/${slotStats.total}</span>
                    </div>
                    <div style="font-size:0.75rem;color:#94a3b8;line-height:1.6;">
                        ${Object.keys(planetSlotRules).map(planetId => {
                            const rule = planetSlotRules[planetId];
                            const unlocked = isSlotPlanetUnlocked(planetId);
                            const used = getPlanetUsedSlots(planetId);
                            return `${rule.name}: ${unlocked ? `${used}/${getPlanetTotalSlots(planetId)}` : `ğŸ”’ Lv.${rule.unlockTech}`}`;
                        }).join(' ï½œ ')}
                    </div>
                `;
                container.appendChild(summary);
            }

            game.upgrades[category].forEach((upgrade, index) => {
                if (category === 'tech') {
                    const canAfford = game.tech >= upgrade.baseCost;
                    const isLocked = index > 0 && !game.upgrades.tech[index - 1].unlocked;
                    const alreadyUnlocked = upgrade.unlocked;

                    const card = document.createElement('div');
                    card.className = `upgrade-card ${alreadyUnlocked ? 'disabled' : canAfford && !isLocked ? '' : 'disabled'}`;
                    card.innerHTML = `
                        <div class="upgrade-card-header">
                            <span class="upgrade-name">${upgrade.icon} ${upgrade.name}</span>
                            <span class="upgrade-level-badge">${alreadyUnlocked ? 'âœ“ å·²è§£é”' : isLocked ? 'ğŸ”’ é”å®š' : 'æœªè§£é”'}</span>
                        </div>
                        <div style="font-size:0.75rem;color:#94a3b8;margin:0.5rem 0;line-height:1.4;">${upgrade.desc}</div>
                        <div class="upgrade-stats">
                            <span class="upgrade-cost-label">ğŸ”¬ ${formatNumber(upgrade.baseCost)} ç§‘ç ”å€¼</span>
                            <span style="color:#a855f7;font-size:0.75rem;">Lv.${upgrade.techLevel}</span>
                        </div>
                        ${isLocked ? '<div style="font-size:0.7rem;color:#f59e0b;margin-top:0.3rem;">éœ€è¦å‰ç½®ç§‘æŠ€</div>' : ''}
                    `;

                    if (!alreadyUnlocked && !isLocked) {
                        card.onclick = () => buyTech(upgrade);
                    }
                    container.appendChild(card);
                } else {
                    const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult || 1.12, upgrade.level));
                    const costType = upgrade.costType || 'ore';
                    const canAfford = costType === 'ore' ? game.ore >= cost : game.energy >= cost;
                    const slotStats = (category === 'mining' || category === 'energy') ? getUnlockedSlotStats() : null;
                    const hasSlot = (category === 'mining' || category === 'energy') ? slotStats.used < slotStats.total : true;
                    const nextPlanet = category === 'mining' ? getNextPlacementPlanet(upgrade.buildingKey) : null;

                    let costIcon = costType === 'ore' ? 'ğŸ’' : 'âš¡';
                    let costName = costType === 'ore' ? 'çŸ¿çŸ³' : 'èƒ½æº';

                    let prodText = '';
                    if (category === 'mining' && upgrade.buildingKey === 'autoFactory') {
                        prodText = `æ¯åº§ ğŸ’ +${formatNumber(upgrade.baseProduction)}/ç§’`;
                    } else if (category === 'mining' && upgrade.buildingKey === 'robotLegion') {
                        prodText = `æ¯åº§ ç‚¹å‡» +${Math.round((upgrade.clickBonusMult - 1) * 100)}%`;
                    } else if (upgrade.outputType === 'ore') {
                        const production = upgrade.baseProduction * upgrade.level;
                        prodText = production > 0 ? `ğŸ’ +${formatNumber(production)}/ç§’` : '';
                    } else if (upgrade.outputType === 'energy') {
                        const production = upgrade.baseProduction * upgrade.level;
                        prodText = production > 0 ? `âš¡ +${formatNumber(production)}/ç§’ï¼ˆæ¯æ¬¡å»ºé€ å 1æ§½ï¼‰` : 'æ¯æ¬¡å»ºé€ å 1æ§½';
                    } else if (upgrade.bonus === 'click') {
                        prodText = `ç‚¹å‡» +${upgrade.baseProduction * upgrade.level}`;
                    } else if (upgrade.bonus === 'energyBoost') {
                        prodText = upgrade.level > 0 ? `èƒ½æº Ã—${upgrade.boostValue}` : '';
                    } else if (upgrade.bonus === 'energyFlat') {
                        const production = upgrade.baseProduction * upgrade.level;
                        prodText = production > 0 ? `âš¡ +${formatNumber(production)}/ç§’` : '';
                    } else if (upgrade.bonus === 'techBoost') {
                        const techMult = Math.pow(upgrade.techBoostValue || 1, upgrade.level || 0);
                        prodText = upgrade.level > 0 ? `ç§‘ç ” Ã—${techMult.toFixed(2)}` : '';
                    } else if (upgrade.bonus === 'speed') {
                        prodText = upgrade.level > 0 ? `é€Ÿåº¦ Ã—${upgrade.speedMult}` : '';
                    }

                    const card = document.createElement('div');
                    card.className = `upgrade-card ${canAfford && hasSlot ? '' : 'disabled'}`;
                    card.innerHTML = `
                        <div class="upgrade-card-header">
                            <span class="upgrade-name">${upgrade.icon} ${upgrade.name}</span>
                            <span class="upgrade-level-badge">Lv.${upgrade.level}</span>
                        </div>
                        ${(category === 'mining' || category === 'energy') ? `<div style="font-size:0.72rem;color:#94a3b8;margin:0.35rem 0;">${hasSlot ? (category === 'mining' ? `ä¸‹ä¸€ä¸ªéƒ¨ç½²æ˜Ÿçƒï¼š${planetSlotRules[nextPlanet]?.name || 'â€”'}` : `å¯ç”¨æ§½ä½ï¼š${slotStats.total - slotStats.used}`) : 'å½“å‰å¯ç”¨æ§½ä½å·²æ»¡ï¼Œè¯·å…ˆè§£é”æ›´é«˜æ–‡æ˜å±‚çº§'}</div>` : ''}
                        <div class="upgrade-stats">
                            <span class="upgrade-cost-label">${costIcon} ${formatNumber(cost)} ${costName}</span>
                            <span class="upgrade-prod-label">${prodText}</span>
                        </div>
                    `;

                    card.onclick = () => buyUpgrade(upgrade);
                    container.appendChild(card);
                }
            });
        }

        // æ¸²æŸ“å‡çº§
        function renderUpgrades() {
            for (let category in game.upgrades) {
                renderUpgradeCategory(category);
            }
        }

        // è´­ä¹°å‡çº§
        function buyUpgrade(upgrade) {
            const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult || 1.12, upgrade.level));
            const costType = upgrade.costType || 'ore';
            
            const canAfford = costType === 'ore' ? game.ore >= cost : game.energy >= cost;
            
            if (canAfford) {
                if (upgrade.category === 'mining' || upgrade.category === 'energy') {
                    const slotStats = getUnlockedSlotStats();
                    if (slotStats.used >= slotStats.total) {
                        return;
                    }
                }

                if (costType === 'ore') {
                    game.ore -= cost;
                } else {
                    game.energy -= cost;
                }

                if (upgrade.category === 'mining') {
                    const placed = placeMiningBuilding(upgrade.buildingKey);
                    if (!placed) {
                        if (costType === 'ore') game.ore += cost;
                        else game.energy += cost;
                        return;
                    }
                } else if (upgrade.category === 'energy') {
                    const energyPlanet = 'earth';
                    const emptyIndex = getFirstEmptySlotIndex(energyPlanet);
                    if (emptyIndex < 0) {
                        if (costType === 'ore') game.ore += cost;
                        else game.energy += cost;
                        return;
                    }
                    game.slotLayout[energyPlanet][emptyIndex] = 'energyStation';
                    upgrade.level++;
                    syncMiningLevelsWithSlots();
                } else {
                    upgrade.level++;
                }

                updateProduction();
                if (upgrade.category === 'mining' || upgrade.category === 'energy') {
                    renderUpgradeCategory('mining');
                    renderUpgradeCategory('energy');
                } else {
                    renderUpgradeCategory(upgrade.category);
                }
                updateUI();
            }
        }

        // è´­ä¹°ç§‘æŠ€
        function buyTech(tech) {
            if (game.tech >= tech.baseCost && !tech.unlocked) {
                game.tech -= tech.baseCost;
                tech.unlocked = true;
                game.techLevel = tech.techLevel;
                
                // æ›´æ–°æ–‡æ˜ç­‰çº§æ˜¾ç¤º
                const techNames = ['ğŸŒ è¡Œæ˜Ÿæ–‡æ˜', 'ğŸŒ™ åœ°æœˆæ–‡æ˜', 'â˜€ï¸ å¤ªé˜³ç³»æ–‡æ˜', 'ğŸŒ  æ˜Ÿé™…æ–‡æ˜', 'ğŸŒŒ é“¶æ²³æ–‡æ˜'];
                document.getElementById('civLevel').textContent = techNames[game.techLevel];
                
                // é‡ç½®ç”¨æˆ·ç¼©æ”¾ï¼Œå¹³æ»‘è¿‡æ¸¡åˆ°æ–°æ¨èè§†è§’
                applyUserZoom();
                
                // æ›´æ–°å¤ªé˜³ç³»èƒŒæ™¯å±‚è§†è§‰æ•ˆæœ
                updateSolarOverlay();

                // ç­‰åœºæ™¯è¿‡æ¸¡åŠ¨ç”»å®Œæˆåå†æ˜¾ç¤ºé€šçŸ¥
                setTimeout(() => {
                    showTechUnlocked(tech);
                }, 2600);
                
                updateProduction();
                renderUpgradeCategory('tech');
                renderUpgradeCategory('mining');
                renderUpgradeCategory('energy');
                updateUI();

                if (typeof closeRightPanel === 'function') {
                    closeRightPanel();
                }
            }
        }
        
        // æ˜¾ç¤ºç§‘æŠ€è§£é”é€šçŸ¥
        function showTechUnlocked(tech) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(15, 23, 42, 0.98);
                padding: 2rem 2.5rem;
                border-radius: 20px;
                border: 2px solid var(--accent-cyan);
                max-width: 500px;
                z-index: 9999;
                backdrop-filter: blur(15px);
                box-shadow: 0 0 60px rgba(0, 217, 255, 0.4);
                text-align: center;
            `;
            modal.innerHTML = `
                <div style="font-family: var(--font-ui); font-size: 1.8rem; font-weight: 700; color: var(--accent-cyan); margin-bottom: 1rem;">
                    ${tech.icon} ${tech.name}
                </div>
                <div style="color: #cbd5e1; margin-bottom: 1.5rem; line-height: 1.6;">
                    ${tech.desc}
                </div>
                <button onclick="this.parentElement.remove()" style="
                    width: 100%;
                    background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
                    border: none;
                    padding: 0.8rem;
                    border-radius: 10px;
                    color: white;
                    font-size: 1rem;
                    font-weight: 700;
                    cursor: pointer;
                    font-family: var(--font-ui);
                ">ç»§ç»­æ¢ç´¢ â†’</button>
            `;
            document.body.appendChild(modal);
        }

        // æ›´æ–°äº§é‡
        function updateProduction() {
            const autoFactoryUpgrade = game.upgrades.mining.find(u => u.id === 'mf1');
            const robotLegionUpgrade = game.upgrades.mining.find(u => u.id === 'mr1');
            const autoFactoryCount = getBuildingCount('autoFactory');
            const robotLegionCount = getBuildingCount('robotLegion');
            const energyStationCount = getBuildingCount('energyStation');
            const researchCenterCount = getResearchCenterCount();

            game.orePerSec = autoFactoryCount * (autoFactoryUpgrade?.baseProduction || 0);
            game.energyPerSec = 0;
            game.techPerSec = 0;
            game.researchPowerNeed = 0;
            game.robotPowerNeed = 0;
            game.robotSupportCap = 0;
            game.robotOverCap = 0;
            game.robotPenalty = 1;

            const robotBonus = 1 + robotLegionCount * ((robotLegionUpgrade?.clickBonusMult || 1.35) - 1);
            const elevator = game.upgrades.special.find(u => u.id === 'sp1');
            const flatClickBonus = (elevator?.level || 0) * (elevator?.baseProduction || 0);
            const rawClickPower = game.baseClickPower * robotBonus + flatClickBonus;
            game.clickPower = Math.max(1, Math.floor(rawClickPower));

            // 1. è®¡ç®—èƒ½æºäº§é‡ï¼ˆèƒ½æºè®¾æ–½ï¼‰
            game.upgrades.energy.forEach(upgrade => {
                if (upgrade.outputType === 'energy') {
                    game.energyPerSec += upgrade.baseProduction * upgrade.level;
                }
            });

            game.upgrades.special.forEach(upgrade => {
                if (upgrade.bonus === 'energyFlat' && upgrade.level > 0) {
                    game.energyPerSec += upgrade.baseProduction * upgrade.level;
                }
            });

            const rawEnergyPerSec = game.energyPerSec;

            // 2. ç§‘æŠ€äº§é‡ + æœºå™¨äººå†›å›¢å…»æŠ¤ï¼šå…±äº«ç”µåŠ›ä¾›ç»™
            const powerNeedPerCenter = 3.5;
            const powerNeedPerRobotLegion = 1.2;
            const researchPowerNeed = researchCenterCount * powerNeedPerCenter;
            const robotPowerNeed = robotLegionCount * powerNeedPerRobotLegion;
            const totalPowerNeed = researchPowerNeed + robotPowerNeed;
            const sharedPowerEfficiency = totalPowerNeed > 0
                ? Math.min(1, rawEnergyPerSec / totalPowerNeed)
                : 1;
            const researchEfficiency = researchPowerNeed > 0 ? sharedPowerEfficiency : 0;
            const robotPowerEfficiency = robotPowerNeed > 0 ? sharedPowerEfficiency : 1;
            const effectiveResearchPowerNeed = researchPowerNeed * researchEfficiency;
            const effectiveRobotPowerNeed = robotPowerNeed * robotPowerEfficiency;

            game.researchPowerNeed = effectiveResearchPowerNeed;
            game.robotPowerNeed = effectiveRobotPowerNeed;
            game.energyPerSec = Math.max(0, rawEnergyPerSec - effectiveResearchPowerNeed - effectiveRobotPowerNeed);
            game.techPerSec = researchCenterCount * 1 * researchEfficiency;

            // 3. ç‰¹æ®Šå»ºç­‘åŠ æˆ
            const techNetLevel = game.upgrades.special.find(u => u.id === 'sp5')?.level || 0;
            if (techNetLevel > 0) {
                const techBoost = game.upgrades.special.find(u => u.id === 'sp5')?.techBoostValue || 1;
                game.techPerSec *= Math.pow(techBoost, techNetLevel);
            }

            // 4. æœºå™¨äººå†›å›¢è¶…ç¼–æƒ©ç½šï¼ˆå‡äº§ï¼‰
            const supportCap = Math.max(0, energyStationCount * 2);
            const overCap = Math.max(0, robotLegionCount - supportCap);
            const penalty = overCap > 0 ? Math.max(0.45, 1 - overCap * 0.12) : 1;
            game.robotSupportCap = supportCap;
            game.robotOverCap = overCap;
            game.robotPenalty = penalty;

            if (penalty < 1) {
                game.orePerSec *= penalty;
                game.techPerSec *= penalty;
                game.clickPower = Math.max(1, Math.floor(rawClickPower * (0.82 + 0.18 * penalty)));
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            const gameDateEl = document.getElementById('gameDate');
            if (gameDateEl) {
                gameDateEl.textContent = getCalendarText();
            }
            document.getElementById('oreVal').textContent = formatNumber(game.ore);
            document.getElementById('energyVal').textContent = formatNumber(game.energy);
            document.getElementById('techVal').textContent = formatNumber(game.tech);
            document.getElementById('oreRate').textContent = '+' + formatNumber(game.orePerSec) + '/ç§’';
            document.getElementById('energyRate').textContent = '+' + formatNumber(game.energyPerSec) + '/ç§’';
            document.getElementById('techRate').textContent = '+' + formatNumber(game.techPerSec) + '/ç§’';
            updateLevelActionHud();
        }

        // æ£€æŸ¥é˜¶æ®µè¿›åº¦
        function checkStageProgress() {
            const currentStage = stages[game.currentStage];
            const nextStage = stages[game.currentStage + 1];
            const conquestLevel = Math.max(0, Math.min(earthConquestMilestones.length, Number(game.earthConquestLevel) || 0));
            const hasConquestGoal = conquestLevel < earthConquestMilestones.length;
            const moonBridge = game.upgrades.tech.find(item => item.id === 't1');
            const moonBridgeUnlocked = !!moonBridge?.unlocked;
            const solarBridge = game.upgrades.tech.find(item => item.id === 't2');
            const solarBridgeUnlocked = !!solarBridge?.unlocked;
            const interstellarBridge = game.upgrades.tech.find(item => item.id === 't3');
            const interstellarBridgeUnlocked = !!interstellarBridge?.unlocked;
            const researchCenterCount = getResearchCenterCount();
            const energyStationCount = getBuildingCount('energyStation');
            const moonRobotCount = getPlanetSlotAssignments('moon').filter(item => item === 'robotLegion').length;
            const moonClicks = Math.max(0, Number(game.moonClickCount) || 0);
            const venusClicks = Math.max(0, Number(game.venusClickCount) || 0);
            const mercuryClicks = Math.max(0, Number(game.mercuryClickCount) || 0);
            let stage3TaskStep = 10;
            if (researchCenterCount < 1) {
                stage3TaskStep = 1;
            } else if (energyStationCount < 2) {
                stage3TaskStep = 2;
            } else if (!moonBridgeUnlocked) {
                stage3TaskStep = 3;
            } else if (moonClicks < 5) {
                stage3TaskStep = 4;
            } else if (moonRobotCount < 1) {
                stage3TaskStep = 5;
            } else if (venusClicks < 5) {
                stage3TaskStep = 6;
            } else if (mercuryClicks < 10) {
                stage3TaskStep = 7;
            } else if (!solarBridgeUnlocked) {
                stage3TaskStep = 8;
            } else if (!game.marsBattleWon) {
                stage3TaskStep = 9;
            } else if (!interstellarBridgeUnlocked) {
                stage3TaskStep = 10;
            }

            if (nextStage) {
                if (nextStage.id === 2) {
                    if ((game.earthClickCount || 0) >= 5) {
                        advanceStage(nextStage);
                    }
                } else if (nextStage.id === 3) {
                    if (stage3TaskStep >= 12) {
                        advanceStage(nextStage);
                    }
                } else if (game.totalEarned >= nextStage.threshold) {
                    advanceStage(nextStage);
                }
            }

            if (hasConquestGoal) {
                const clickTarget = earthConquestMilestones[conquestLevel] || 5;
                const clicks = Math.max(0, Number(game.earthClickCount) || 0);
                const progress = Math.min(100, (clicks / clickTarget) * 100);
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressPercent').textContent = `${Math.min(clicks, clickTarget)} / ${clickTarget}`;
                document.getElementById('progressTitle').textContent = `ğŸ¯ ç‚¹å‡»åœ°çƒ${clickTarget}æ¬¡`;
                return;
            }

            if (nextStage) {
                if (nextStage.id === 2) {
                    const nextConquestIndex = Math.max(0, Math.min(earthConquestMilestones.length - 1, Number(game.earthConquestLevel) || 0));
                    const clickTarget = earthConquestMilestones[nextConquestIndex] || 5;
                    const clicks = Math.max(0, Number(game.earthClickCount) || 0);
                    const progress = Math.min(100, (clicks / clickTarget) * 100);
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressPercent').textContent = `${Math.min(clicks, clickTarget)} / ${clickTarget}`;
                    document.getElementById('progressTitle').textContent = `ğŸ¯ ç‚¹å‡»åœ°çƒ${clickTarget}æ¬¡`;
                } else if (nextStage.id === 3) {
                    if (stage3TaskStep === 1) {
                        const target = 1;
                        const progress = Math.min(100, (researchCenterCount / target) * 100);
                        document.getElementById('progressBar').style.width = progress + '%';
                        document.getElementById('progressPercent').textContent = `${Math.min(researchCenterCount, target)} / ${target}`;
                        document.getElementById('progressTitle').textContent = 'ğŸ¯ ä¿®å»º1ä¸ªç§‘ç ”ä¸­å¿ƒ';
                    } else if (stage3TaskStep === 2) {
                        const target = 2;
                        const progress = Math.min(100, (energyStationCount / target) * 100);
                        document.getElementById('progressBar').style.width = progress + '%';
                        document.getElementById('progressPercent').textContent = `${Math.min(energyStationCount, target)} / ${target}`;
                        document.getElementById('progressTitle').textContent = 'ğŸ¯ ä¿®å»º2ä¸ªç”µå‚è®©ç§‘ç ”ä¸­å¿ƒæ­£å¸¸è¿è½¬';
                    } else if (stage3TaskStep === 3) {
                        const target = 1;
                        const done = moonBridgeUnlocked ? 1 : 0;
                        document.getElementById('progressBar').style.width = `${done * 100}%`;
                        document.getElementById('progressPercent').textContent = `${done} / ${target}`;
                        document.getElementById('progressTitle').textContent = 'ğŸ¯ ç ”ç©¶åœ°æœˆæ¡¥ç§‘æŠ€ï¼Œäººç±»å¤§è§„æ¨¡èµ°å‡ºåœ°çƒ';
                    } else if (stage3TaskStep === 4) {
                        const target = 5;
                        const progress = Math.min(100, (moonClicks / target) * 100);
                        document.getElementById('progressBar').style.width = progress + '%';
                        document.getElementById('progressPercent').textContent = `${Math.min(moonClicks, target)} / ${target}`;
                        document.getElementById('progressTitle').textContent = 'ğŸ¯ å¾æœæœˆçƒï¼ˆç‚¹å‡»æœˆçƒ5æ¬¡ï¼‰';
                    } else if (stage3TaskStep === 5) {
                        const target = 1;
                        const done = Math.min(1, moonRobotCount);
                        document.getElementById('progressBar').style.width = `${done * 100}%`;
                        document.getElementById('progressPercent').textContent = `${done} / ${target}`;
                        document.getElementById('progressTitle').textContent = 'ğŸ¯ åœ¨æœˆçƒä¸Šä¿®å»º1ä¸ªæœºå™¨äººå†›å›¢';
                    } else if (stage3TaskStep === 6) {
                        const target = 5;
                        const progress = Math.min(100, (venusClicks / target) * 100);
                        document.getElementById('progressBar').style.width = progress + '%';
                        document.getElementById('progressPercent').textContent = `${Math.min(venusClicks, target)} / ${target}`;
                        document.getElementById('progressTitle').textContent = 'ğŸ¯ å¾æœé‡‘æ˜Ÿï¼ˆç‚¹å‡»é‡‘æ˜Ÿ5æ¬¡ï¼‰';
                    } else if (stage3TaskStep === 7) {
                        const target = 10;
                        const progress = Math.min(100, (mercuryClicks / target) * 100);
                        document.getElementById('progressBar').style.width = progress + '%';
                        document.getElementById('progressPercent').textContent = `${Math.min(mercuryClicks, target)} / ${target}`;
                        document.getElementById('progressTitle').textContent = 'ğŸ¯ å¾æœæ°´æ˜Ÿï¼ˆç‚¹å‡»æ°´æ˜Ÿ10æ¬¡ï¼‰';
                    } else if (stage3TaskStep === 8) {
                        const target = 1;
                        const done = solarBridgeUnlocked ? 1 : 0;
                        document.getElementById('progressBar').style.width = `${done * 100}%`;
                        document.getElementById('progressPercent').textContent = `${done} / ${target}`;
                        document.getElementById('progressTitle').textContent = 'ğŸ¯ ç ”ç©¶å¤ªé˜³ç³»å¼•åŠ›æ¡¥ç§‘æŠ€ï¼Œäººç±»å‘å¤ªé˜³ç³»æ®–æ°‘';
                    } else if (stage3TaskStep === 9) {
                        const done = game.marsBattleWon ? 1 : 0;
                        document.getElementById('progressBar').style.width = `${done * 100}%`;
                        document.getElementById('progressPercent').textContent = `${done} / 1`;
                        document.getElementById('progressTitle').textContent = 'ğŸ¯ ç«æ˜Ÿæˆ˜äº‰ï¼šç‚¹å‡»æˆ˜æ–—æŒ‰é’®å¹¶è·èƒœ';
                    } else if (stage3TaskStep === 10) {
                        const target = 1;
                        const done = interstellarBridgeUnlocked ? 1 : 0;
                        document.getElementById('progressBar').style.width = `${done * 100}%`;
                        document.getElementById('progressPercent').textContent = `${done} / ${target}`;
                        document.getElementById('progressTitle').textContent = 'ğŸ¯ ç ”ç©¶æ˜Ÿé™…å¼•åŠ›æ¡¥ç§‘æŠ€ï¼Œå¼€å¯ä¸‹ä¸€é˜¶æ®µè¿œå¾';
                    } else {
                        document.getElementById('progressBar').style.width = '100%';
                        document.getElementById('progressPercent').textContent = '1 / 1';
                        document.getElementById('progressTitle').textContent = 'âœ… ç«æ˜Ÿæˆ˜å½¹å®Œæˆï¼Œæ˜Ÿé™…è¿œå¾æ¡ä»¶å·²è¾¾æˆ';
                    }
                } else {
                    const progress = ((game.totalEarned - currentStage.threshold) /
                                     (nextStage.threshold - currentStage.threshold)) * 100;
                    document.getElementById('progressBar').style.width = Math.min(progress, 100) + '%';
                    document.getElementById('progressPercent').textContent =
                        `${Math.floor(Math.min(progress, 100))}% (${formatNumber(game.totalEarned)} / ${formatNumber(nextStage.threshold)})`;
                    document.getElementById('progressTitle').textContent = 'ğŸ¯ è·ç¦»' + nextStage.name;
                }
            } else {
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressPercent').textContent = '100% - æ–‡æ˜å·…å³°';
                document.getElementById('progressTitle').textContent = 'ğŸ‰ æ–‡æ˜å·…å³°';
            }
        }

        function showEarthConquestMilestone(message) {
            const modal = document.createElement('div');
            modal.className = 'milestone-overlay';
            modal.innerHTML = `
                <div class="milestone-box">
                    <div class="milestone-emoji">ğŸŒ</div>
                    <div class="milestone-heading">${message}</div>
                    <div class="milestone-description">åœ°çƒæ–°å¢ 1 ä¸ªæ§½ä½</div>
                    <button class="milestone-cta">ç»§ç»­å¾æœ</button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('button').onclick = () => modal.remove();
        }

        function handleEarthConquestClick() {
            game.earthClickCount = Math.max(0, Number(game.earthClickCount) || 0) + 1;
            let changed = false;
            while ((game.earthConquestLevel || 0) < earthConquestMilestones.length) {
                const nextLevel = game.earthConquestLevel || 0;
                const needClicks = earthConquestMilestones[nextLevel];
                if (game.earthClickCount < needClicks) break;
                game.earthConquestLevel = nextLevel + 1;
                showEarthConquestMilestone(earthConquestMessages[nextLevel]);
                changed = true;
            }
            if (changed) {
                renderUpgrades();
                updateProduction();
                updateUI();
            }
            checkStageProgress();
        }

        function handlePlanetTaskClick(planetId) {
            if (planetId === 'moon') {
                const prev = Math.max(0, Number(game.moonClickCount) || 0);
                game.moonClickCount = prev + 1;
                if (prev < 5 && game.moonClickCount >= 5) {
                    renderUpgrades();
                    updateUI();
                }
            } else if (planetId === 'venus') {
                game.venusClickCount = Math.max(0, Number(game.venusClickCount) || 0) + 1;
            } else if (planetId === 'mercury') {
                game.mercuryClickCount = Math.max(0, Number(game.mercuryClickCount) || 0) + 1;
            } else if (planetId === 'mars') {
                game.marsClickCount = Math.max(0, Number(game.marsClickCount) || 0) + 1;
            } else if (planetId === 'jupiter') {
                game.jupiterClickCount = Math.max(0, Number(game.jupiterClickCount) || 0) + 1;
            } else if (planetId === 'saturn') {
                game.saturnClickCount = Math.max(0, Number(game.saturnClickCount) || 0) + 1;
            } else {
                return;
            }
            checkStageProgress();
        }

        // æ¨è¿›é˜¶æ®µ
        function advanceStage(stage) {
            game.currentStage = stage.id;
            document.getElementById('civLevel').textContent = stage.name;

            // è§£é”è¡Œæ˜Ÿ
            planets.forEach(planet => {
                if (planet.unlockStage === stage.id && planet.id !== 'sun') {
                    game.unlockedPlanets.push(planet.id);
                }
            });

            if (stage.id !== 1 && stage.id !== 2 && stage.id !== 3) {
                showMilestone(stage);
            }
        }

        // æ˜¾ç¤ºé‡Œç¨‹ç¢‘
        function showMilestone(stage) {
            const modal = document.createElement('div');
            modal.className = 'milestone-overlay';
            modal.innerHTML = `
                <div class="milestone-box">
                    <div class="milestone-emoji">ğŸ‰</div>
                    <div class="milestone-heading">${stage.name}</div>
                    <div class="milestone-description">${stage.desc}</div>
                    <button class="milestone-cta">ç»§ç»­æ¢ç´¢å®‡å®™</button>
                </div>
            `;

            document.body.appendChild(modal);
            modal.querySelector('button').onclick = () => modal.remove();
        }

        function switchToTab(tabName) {
            renderUpgradeCategory(tabName);
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const btn = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
            const content = document.getElementById('tab-' + tabName);
            if (btn) btn.classList.add('active');
            if (content) content.classList.add('active');
        }

        // Tabåˆ‡æ¢
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                switchToTab(btn.dataset.tab);
            });
        });

        // æ¸¸æˆå¾ªç¯
        setInterval(() => {
            game.ore += game.orePerSec / 5;
            game.energy += game.energyPerSec / 5;
            game.tech += game.techPerSec / 5;
            game.totalEarned += game.orePerSec / 5;
            game.calendarMonthsElapsed += 0.2;
            
            updateUI();
            checkStageProgress();
        }, 200);

        // æ¸²æŸ“å¾ªç¯ - é™åˆ¶å¸§ç‡åˆ°30FPSä»¥é™ä½CPUå ç”¨
        let lastFrameTime = 0;
        function gameLoop(timestamp) {
            // é™åˆ¶åˆ°30FPS (çº¦33msä¸€å¸§)
            if (timestamp - lastFrameTime >= 33) {
                drawSolarSystem();
                lastFrameTime = timestamp;
            }
            requestAnimationFrame(gameLoop);
        }

        // è‡ªåŠ¨ä¿å­˜ï¼ˆåªåœ¨é€‰æ‹©å›½å®¶åæ‰ä¿å­˜ï¼‰
        setInterval(() => {
            if (game.country) {  // åªæœ‰é€‰æ‹©äº†å›½å®¶æ‰ä¿å­˜
                game.lastSaveTime = Date.now();
                localStorage.setItem('spaceEmpireV5', JSON.stringify(game));
            }
        }, 5000);

        // åŠ è½½æ¸¸æˆ
        function loadGame() {
            const saved = localStorage.getItem('spaceEmpireV5');
            if (!saved) return false;

            const savedGame = JSON.parse(saved);
            Object.assign(game, savedGame);
            game.upgrades = buildUpgradesState(savedGame.upgrades);
            game.startYear = Number(game.startYear) || 2025;
            game.calendarMonthsElapsed = Math.max(0, Number(game.calendarMonthsElapsed) || 0);
            game.baseClickPower = Number(game.baseClickPower) > 0 ? Number(game.baseClickPower) : (Number(game.clickPower) > 0 ? Number(game.clickPower) : 100);
            game.earthClickCount = Math.max(0, Number(game.earthClickCount) || 0);
            game.earthConquestLevel = Math.max(0, Math.min(4, Math.floor(Number(game.earthConquestLevel) || 0)));
            game.moonClickCount = Math.max(0, Number(game.moonClickCount) || 0);
            game.venusClickCount = Math.max(0, Number(game.venusClickCount) || 0);
            game.mercuryClickCount = Math.max(0, Number(game.mercuryClickCount) || 0);
            game.marsClickCount = Math.max(0, Number(game.marsClickCount) || 0);
            game.jupiterClickCount = Math.max(0, Number(game.jupiterClickCount) || 0);
            game.saturnClickCount = Math.max(0, Number(game.saturnClickCount) || 0);
            game.marsBattleWon = !!game.marsBattleWon;
            game.marsBattlePhase = Math.max(0, Math.min(1, Number(game.marsBattlePhase) || 0));
            game.planetSlots = normalizePlanetSlots(savedGame.planetSlots);
            game.slotLayout = normalizeSlotLayout(savedGame.slotLayout, game.planetSlots, game.upgrades);
            syncMiningLevelsWithSlots();

            const offlineTime = (Date.now() - game.lastSaveTime) / 1000;
            if (offlineTime > 60) {
                const offlineOre = game.orePerSec * Math.min(offlineTime, 3600 * 4);
                const offlineEnergy = game.energyPerSec * Math.min(offlineTime, 3600 * 4);
                const offlineTech = game.techPerSec * Math.min(offlineTime, 3600 * 4);
                
                showOfflineEarnings(offlineOre, offlineEnergy, offlineTech, offlineTime);
                game.ore += offlineOre;
                game.energy += offlineEnergy;
                game.tech += offlineTech;
            }

            const techNames = ['ğŸŒ è¡Œæ˜Ÿæ–‡æ˜', 'ğŸŒ™ åœ°æœˆæ–‡æ˜', 'â˜€ï¸ å¤ªé˜³ç³»æ–‡æ˜', 'ğŸŒ  æ˜Ÿé™…æ–‡æ˜', 'ğŸŒŒ é“¶æ²³æ–‡æ˜'];
            document.getElementById('civLevel').textContent = techNames[game.techLevel] || techNames[0];
            updateSolarOverlay();  // æ¢å¤å¤ªé˜³ç³»èƒŒæ™¯å±‚çŠ¶æ€
            updateProduction();
            return true;
        }

        function showOfflineEarnings(ore, energy, tech, time) {
            const hours = Math.floor(time / 3600);
            const minutes = Math.floor((time % 3600) / 60);

            const modal = document.createElement('div');
            modal.className = 'offline-modal';
            modal.innerHTML = `
                <div class="offline-box">
                    <div class="offline-title">æ¬¢è¿å›æ¥ï¼</div>
                    <div>ç¦»çº¿æ—¶é—´: ${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ</div>
                    <div class="offline-amount">ğŸ’ +${formatNumber(ore)}</div>
                    <div class="offline-amount" style="font-size:2rem;margin:0.5rem 0;">âš¡ +${formatNumber(energy)}</div>
                    <div class="offline-amount" style="font-size:1.5rem;margin:0.5rem 0;">ğŸ”¬ +${formatNumber(tech)}</div>
                    <div style="margin-bottom: 1.5rem;">èµ„æºå·²è‡ªåŠ¨æ”¶é›†</div>
                    <button class="offline-btn">å¤ªæ£’äº†ï¼</button>
                </div>
            `;

            document.body.appendChild(modal);
            modal.querySelector('button').onclick = () => {
                modal.remove();
                updateUI();
            };
        }

        function openSlotBuildMenu(planetId, slotIndex) {
            const modal = document.getElementById('slotBuildModal');
            const title = document.getElementById('slotBuildTitle');
            const desc = document.getElementById('slotBuildDesc');
            const actions = document.getElementById('slotBuildActions');
            if (!modal || !title || !desc || !actions) return;

            const rule = planetSlotRules[planetId];
            if (!rule || !isSlotPlanetUnlocked(planetId)) return;

            const assignments = getPlanetSlotAssignments(planetId);
            const slotType = assignments[slotIndex] || null;

            title.textContent = `ğŸ§© ${rule.name}`;
            desc.textContent = '';
            actions.innerHTML = '';

            if (!slotType) {
                const baseBuildOptions = [
                    { key: 'autoFactory', label: 'å»ºé€  ğŸ­ è‡ªåŠ¨å·¥å‚' },
                    { key: 'robotLegion', label: 'å»ºé€  ğŸ¤– æœºå™¨äººå†›å›¢' }
                ];
                const buildOptions = baseBuildOptions.filter(option => isBuildingAllowedOnPlanet(planetId, option.key));
                buildOptions.forEach(option => {
                    const cost = getMiningBuildCost(option.key);
                    const upgrade = getMiningUpgradeByBuildingKey(option.key);
                    const effectText = option.key === 'autoFactory'
                        ? `æ¯ç§’ +${formatNumber(upgrade?.baseProduction || 0)} çŸ¿çŸ³`
                        : `ç‚¹å‡»æ”¶ç›Š +${Math.round(((upgrade?.clickBonusMult || 1) - 1) * 100)}%`;
                    const button = document.createElement('button');
                    button.className = 'slot-build-btn';
                    button.textContent = `${option.label}ï¼ˆğŸ’ ${formatNumber(cost)}ï¼‰ Â· ${effectText}`;
                    button.disabled = !Number.isFinite(cost) || game.ore < cost;
                    button.onclick = () => {
                        const ok = placeMiningBuildingAtSlot(planetId, slotIndex, option.key);
                        if (ok) closeSlotBuildMenu();
                    };
                    actions.appendChild(button);
                });

                if (isBuildingAllowedOnPlanet(planetId, 'energyStation')) {
                    const energyCost = getEnergyBuildCost();
                    const energyUpgrade = game.upgrades.energy.find(item => item.id === 'e1');
                    const energyBtn = document.createElement('button');
                    energyBtn.className = 'slot-build-btn';
                    energyBtn.textContent = `å»ºé€  âš¡ èƒ½æºç”µç«™ï¼ˆğŸ’ ${formatNumber(energyCost)}ï¼‰ Â· æ¯ç§’ +${formatNumber(energyUpgrade?.baseProduction || 0)} èƒ½æº`;
                    energyBtn.disabled = !Number.isFinite(energyCost) || game.ore < energyCost;
                    energyBtn.onclick = () => {
                        const ok = placeEnergyStationAtSlot(planetId, slotIndex);
                        if (ok) closeSlotBuildMenu();
                    };
                    actions.appendChild(energyBtn);
                }

                if (isBuildingAllowedOnPlanet(planetId, 'researchCenter')) {
                    const researchCost = getResearchCenterBuildCost();
                    const researchBtn = document.createElement('button');
                    researchBtn.className = 'slot-build-btn';
                    researchBtn.textContent = `å»ºé€  ğŸ”¬ ç§‘ç ”ä¸­å¿ƒï¼ˆğŸ’ ${formatNumber(researchCost)}ï¼‰ Â· +1ç§‘ç ”/ç§’ï¼Œ-3.5èƒ½æº/ç§’`;
                    researchBtn.disabled = !Number.isFinite(researchCost) || game.ore < researchCost;
                    researchBtn.onclick = () => {
                        const ok = placeResearchCenterAtSlot(planetId, slotIndex);
                        if (ok) closeSlotBuildMenu();
                    };
                    actions.appendChild(researchBtn);
                }
            }

            if (slotType) {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'slot-build-btn';
                removeBtn.textContent = `æ‹†é™¤ ${getSlotLabel(slotType)}ï¼ˆä¸è¿”è¿˜èµ„æºï¼‰`;
                removeBtn.onclick = () => {
                    const ok = removeBuildingFromSlot(planetId, slotIndex);
                    if (ok) closeSlotBuildMenu();
                };
                actions.appendChild(removeBtn);
            }

            modal.classList.add('show');
        }

        function closeSlotBuildMenu() {
            const modal = document.getElementById('slotBuildModal');
            if (modal) modal.classList.remove('show');
            updateLevelActionHud();
        }

        window.openSlotBuildMenu = openSlotBuildMenu;
        window.getPlanetSlotAssignments = getPlanetSlotAssignments;
        window.getBuildingCount = getBuildingCount;
        window.openPlanetSlotMenu = openPlanetSlotMenu;
        window.isSlotPlanetUnlocked = isSlotPlanetUnlocked;
        window.handleEarthConquestClick = handleEarthConquestClick;
        window.handlePlanetTaskClick = handlePlanetTaskClick;

        // ===== å›½å®¶é…ç½® =====
        const countryConfigs = {
            usa:     { name: 'ç¾å›½',   flag: 'ğŸ‡ºğŸ‡¸', ore: 400,  energy: 50,  clickPower: 60  },
            china:   { name: 'ä¸­å›½',   flag: 'ğŸ‡¨ğŸ‡³', ore: 200,  energy: 80,  clickPower: 80  },
            russia:  { name: 'ä¿„ç½—æ–¯', flag: 'ğŸ‡·ğŸ‡º', ore: 500,  energy: 60,  clickPower: 60  },
            germany: { name: 'å¾·å›½',   flag: 'ğŸ‡©ğŸ‡ª', ore: 250,  energy: 70,  clickPower: 60  },
            japan:   { name: 'æ—¥æœ¬',   flag: 'ğŸ‡¯ğŸ‡µ', ore: 150,  energy: 100, clickPower: 60  }
        };

        function selectCountry(id) {
            const cfg = countryConfigs[id];
            game.ore = cfg.ore;
            game.energy = cfg.energy;
            game.totalEarned = 0;  // åˆå§‹ç¤¼åŒ…ä¸è®¡å…¥æ€»æ”¶ç›Šï¼Œé¿å…ç«‹åˆ»è§¦å‘é˜¶æ®µæ¨è¿›
            game.baseClickPower = cfg.clickPower;
            game.clickPower = cfg.clickPower;
            game.startYear = 2025;
            game.calendarMonthsElapsed = 0;
            game.earthClickCount = 0;
            game.earthConquestLevel = 0;
            game.moonClickCount = 0;
            game.venusClickCount = 0;
            game.mercuryClickCount = 0;
            game.marsClickCount = 0;
            game.jupiterClickCount = 0;
            game.saturnClickCount = 0;
            game.country = id;
            game.countryName = cfg.name;
            game.planetSlots = normalizePlanetSlots();
            game.slotLayout = normalizeSlotLayout();
            syncMiningLevelsWithSlots();

            // æ·¡å‡ºé€‰å›½ç•Œé¢ï¼Œæ·¡å…¥æ¸¸æˆ
            const screen = document.getElementById('countryScreen');
            screen.style.transition = 'opacity 0.8s ease';
            screen.style.opacity = '0';
            setTimeout(() => screen.remove(), 800);

            updateUI();
            checkStageProgress();
        }

        function resetGame() {
            if (!confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¼šä¸¢å¤±ï¼')) {
                return;
            }
            // è®¾ç½®é‡ç½®æ ‡å¿—ï¼Œç„¶åæ¸…é™¤å­˜æ¡£
            sessionStorage.setItem('resetFlag', 'true');
            localStorage.removeItem('spaceEmpireV5');
            location.reload(true);  // å¼ºåˆ¶ä»æœåŠ¡å™¨é‡æ–°åŠ è½½
        }

        // æµ‹è¯•ç§‘æŠ€ç­‰çº§ï¼ˆå¾ªç¯åˆ‡æ¢Lv0-4ï¼‰
        function testTechLevel() {
            game.techLevel = (game.techLevel + 1) % 5;
            
            // æ›´æ–°æ˜¾ç¤º
            const techNames = ['ğŸŒ è¡Œæ˜Ÿæ–‡æ˜', 'ğŸŒ™ åœ°æœˆæ–‡æ˜', 'â˜€ï¸ å¤ªé˜³ç³»æ–‡æ˜', 'ğŸŒ  æ˜Ÿé™…æ–‡æ˜', 'ğŸŒŒ é“¶æ²³æ–‡æ˜'];
            document.getElementById('civLevel').textContent = techNames[game.techLevel];
            
            // é‡ç½®ç”¨æˆ·ç¼©æ”¾åˆ°æ¨èè§†è§’
            applyUserZoom();
            
            // æ›´æ–°èƒŒæ™¯å±‚
            updateSolarOverlay();
            
            // è§£é”æ‰€æœ‰æ˜Ÿçƒä»¥ä¾¿è§‚å¯Ÿå…‰è·¯æ•ˆæœ
            game.unlockedPlanets = planets.map(p => p.id);
            
            // æ˜¾ç¤ºæç¤º
            const tip = document.createElement('div');
            tip.style.cssText = `
                position: fixed; top: 50%; left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.9);
                color: #fff;
                padding: 2rem 3rem;
                border-radius: 15px;
                border: 2px solid ${['#fbbf24', '#00d9ff', '#a855f7', '#ff00ff', '#ffffff'][game.techLevel]};
                font-size: 1.5rem;
                font-weight: 700;
                z-index: 9999;
                animation: fadeIn 0.3s ease;
                text-align: center;
            `;
            tip.innerHTML = `
                ${techNames[game.techLevel]}<br>
                <span style="font-size:1rem; opacity:0.8; display:block; margin-top:0.5rem;">
                    è§‚å¯Ÿå…‰è·¯é¢œè‰²ã€ç½‘ç»œå¤æ‚åº¦å’ŒèƒŒæ™¯æ˜Ÿäº‘å˜åŒ–
                </span>
            `;
            document.body.appendChild(tip);
            setTimeout(() => {
                tip.style.transition = 'opacity 0.5s';
                tip.style.opacity = '0';
                setTimeout(() => tip.remove(), 500);
            }, 2000);
        }

        // é¢œè‰²å·¥å…·å‡½æ•°
        function lightenColor(hex, amount) {
            const num = parseInt(hex.replace('#',''), 16);
            const r = Math.min(255, (num >> 16) + amount);
            const g = Math.min(255, ((num >> 8) & 0xFF) + amount);
            const b = Math.min(255, (num & 0xFF) + amount);
            return `rgb(${r},${g},${b})`;
        }
        function darkenColor(hex, amount) {
            const num = parseInt(hex.replace('#',''), 16);
            const r = Math.max(0, (num >> 16) - amount);
            const g = Math.max(0, ((num >> 8) & 0xFF) - amount);
            const b = Math.max(0, (num & 0xFF) - amount);
            return `rgb(${r},${g},${b})`;
        }

        // é¼ æ ‡æ»šè½®ç¼©æ”¾ / è§¦æ‘¸æåˆç¼©æ”¾ â†’ ç”± scene.js ç»Ÿä¸€å¤„ç†
        
        // åˆå§‹åŒ–
        window.addEventListener('resize', () => {
            if (typeof window.scheduleViewportResize === 'function') {
                window.scheduleViewportResize();
            } else {
                resizeCanvas();
            }
        });
        if (typeof window.scheduleViewportResize === 'function') {
            window.scheduleViewportResize();
        } else {
            resizeCanvas();
        }
        // initStarfield() å·²ç§»é™¤ï¼Œæ”¹ç”¨ STARS æ•°ç»„ï¼ˆsolar-scale æ–¹å¼ï¼‰
        initPlanetDivs();   // åˆ›å»ºCSSè¡Œæ˜Ÿdiv
        initUpgrades();
        updateSolarOverlay();  // åˆå§‹åŒ–å¤ªé˜³ç³»æ˜¾ç¤ºï¼ˆåŒæ—¶è§¦å‘åœºæ™¯è¿‡æ¸¡ï¼‰

        // æ£€æŸ¥æ˜¯å¦æ˜¯é‡ç½®æ“ä½œ
        const isReset = sessionStorage.getItem('resetFlag');
        if (isReset) {
            sessionStorage.removeItem('resetFlag');
            // é‡ç½®æ—¶ç¡®ä¿é€‰å›½ç•Œé¢æ˜¾ç¤º
            const countryScreen = document.getElementById('countryScreen');
            if (countryScreen) {
                countryScreen.style.display = 'flex';
                countryScreen.style.opacity = '1';
                countryScreen.scrollTop = 0;
            }
        } else {
            // æ­£å¸¸åŠ è½½ï¼šæœ‰å­˜æ¡£ç›´æ¥è¿›æ¸¸æˆï¼Œæ²¡æœ‰å­˜æ¡£æ˜¾ç¤ºé€‰å›½ç•Œé¢
            const hasSave = loadGame();
            if (hasSave) {
                const countryScreen = document.getElementById('countryScreen');
                if (countryScreen) {
                    countryScreen.remove();
                }
            } else {
                const countryScreen = document.getElementById('countryScreen');
                if (countryScreen) {
                    countryScreen.scrollTop = 0;
                }
            }
        }

        renderUpgrades();
        updateUI();
        checkStageProgress();

        if (window.BattleSystem && typeof window.BattleSystem.init === 'function') {
            window.BattleSystem.init({
                getPlayerStats: () => {
                    const robotLegionCount = Math.max(0, Number(getBuildingCount('robotLegion')) || 0);
                    const isCounterAttack = (Number(game.marsBattlePhase) || 0) >= 1 && !game.marsBattleWon;
                    const playerMaxHp = 40 + robotLegionCount * 10 + (game.techLevel || 0) * 6;
                    const playerAtk = Math.max(3, Math.floor(4 + robotLegionCount * 1.5 + (game.techLevel || 0) * 1.2));
                    return {
                        maxHp: playerMaxHp,
                        atk: playerAtk,
                        enemyMaxHp: isCounterAttack ? 180 : 130,
                        enemyAtk: isCounterAttack ? 18 : 12
                    };
                },
                onWin: () => {
                    if (game.marsBattleWon) return;
                    game.marsBattleWon = true;
                    game.marsBattlePhase = 0;
                    if (window.BattleSystem && typeof window.BattleSystem.setVisible === 'function') {
                        window.BattleSystem.setVisible(false);
                    }
                    updateUI();
                    checkStageProgress();
                    if (typeof window.showStoryEvent === 'function') {
                        window.showStoryEvent(
                            'ğŸ ç«æ˜Ÿæˆ˜å½¹å®Œæˆ',
                            'åœ°çƒè¿œå¾å†›å‡»æºƒç«æ˜Ÿåœ°åº•å†›å›¢ï¼Œæˆ˜åœºä¸»åŠ¨æƒå·²è¢«å¤ºå›ã€‚<br>æ¥ä¸‹æ¥å¯ç»§ç»­éƒ¨ç½²æœºå™¨äººå†›å›¢ç¨³å®šç«æ˜Ÿç§©åºã€‚',
                            'ç»§ç»­æ‰©å¼ '
                        );
                    }
                },
                onLose: () => {
                    const phase = Number(game.marsBattlePhase) || 0;
                    if (phase <= 0) {
                        game.marsBattlePhase = 1;
                        const loss = Math.max(0, Math.floor(game.ore * 0.06));
                        if (loss > 0) game.ore = Math.max(0, game.ore - loss);
                        updateUI();
                        if (typeof window.showStoryEvent === 'function') {
                            window.showStoryEvent(
                                'ğŸš¨ åœ°çƒåå‡»æˆ˜å¯åŠ¨',
                                'ç«æ˜Ÿä¸»æˆ˜çº¿å¤±åˆ©ï¼Œæ•Œå†›åæ‰‘åœ°çƒè½¨é“ã€‚<br>è¡¥ç»™ä¸¥é‡æŸè€— ğŸ’ ' + formatNumber(loss) + 'ï¼Œè¯·ç«‹å³ç»„ç»‡åœ°çƒåå‡»æˆ˜ã€‚<br><span style="color:#fca5a5;">è‹¥åå‡»æˆ˜å†æ¬¡å¤±è´¥ï¼Œåœ°çƒå°†è¢«æ‘§æ¯ã€‚</span>',
                                'ç«‹åˆ»åå‡»',
                                () => {
                                    if (typeof window.openMarsBattle === 'function') {
                                        window.openMarsBattle();
                                    }
                                }
                            );
                        }
                        return;
                    }

                    if (typeof window.showEarthDestroyedEvent === 'function') {
                        window.showEarthDestroyedEvent('åœ°çƒåå‡»æˆ˜å¤±è´¥ï¼Œç«æ˜Ÿåœ°åº•å†›å›¢çªç ´æœ€åé˜²çº¿ï¼åœ°çƒç­äº¡ã€‚');
                    } else {
                        try {
                            localStorage.removeItem('spaceEmpireV5');
                            sessionStorage.setItem('resetFlag', 'true');
                        } catch (_) {}
                        location.reload(true);
                    }
                }
            });
        }

        gameLoop();

        window.addEventListener('beforeunload', () => {
            if (game.country) {  // åªæœ‰é€‰æ‹©äº†å›½å®¶æ‰ä¿å­˜
                localStorage.setItem('spaceEmpireV5', JSON.stringify(game));
            }
        });

        const panelTabs = document.querySelector('.panel-tabs');
        if (panelTabs) panelTabs.style.display = 'none';
        const bottomPanel = document.querySelector('.bottom-panel');
        if (bottomPanel) bottomPanel.classList.add('is-collapsed');
        let activeRightTab = null;

        function openRightPanel(tabName) {
            const panel = document.querySelector('.bottom-panel');
            if (!panel) return;
            const isCollapsed = panel.classList.contains('is-collapsed');
            if (!isCollapsed && activeRightTab === tabName) {
                panel.classList.add('is-collapsed');
                activeRightTab = null;
                return;
            }
            panel.classList.remove('is-collapsed');
            switchToTab(tabName);
            activeRightTab = tabName;
        }

        function closeRightPanel() {
            const panel = document.querySelector('.bottom-panel');
            if (!panel) return;
            panel.classList.add('is-collapsed');
            activeRightTab = null;
        }

        window.switchToTab = switchToTab;
        window.openRightPanel = openRightPanel;
        window.closeRightPanel = closeRightPanel;
        window.openMarsBattle = () => {
            if (game.marsBattleWon) {
                return;
            }
            if (window.BattleSystem && typeof window.BattleSystem.startBattle === 'function') {
                if (typeof window.BattleSystem.setVisible === 'function') {
                    window.BattleSystem.setVisible(true);
                }
                window.BattleSystem.startBattle();
            }
        };
    </script>
</body>
</html>
